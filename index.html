<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SiMERY ‚Äì Aplikasi Manajemen Inventory</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>" type="image/svg+xml">
  <!-- [FIX #1] Preconnect font domains untuk mempercepat loading font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap">
  <!-- [FIX #2] defer pada kedua Google scripts agar tidak blokir render -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" defer></script>
  <style>

:root {
  --accent-1:#0ea5e9;
  --accent-2:#06b6d4;
  --accent-3:#8b5cf6;
  --blue-1:#0ea5e9;
  --blue-2:#38bdf8;
  --blue-3:#7dd3fc;
  --blue-dark:#0369a1;
  --blue-light:#f0f9ff;
  --blue-mid:#bae6fd;
  --text:#0f172a;
  --text-2:#475569;
  --text-3:#94a3b8;
  --muted:#64748b;
  --border:rgba(14,165,233,0.15);
  --border-2:rgba(14,165,233,0.08);
  --surface:#ffffff;
  --bg-start:#f0f9ff;
  --bg-end:#e0f2fe;
  --success:#10b981; --success-light:#ecfdf5;
  --warning:#f59e0b; --warning-light:#fffbeb;
  --danger:#ef4444;  --danger-light:#fef2f2;
  --radius:12px; --radius-lg:16px;
  --shadow-sm:0 1px 4px rgba(14,165,233,0.06);
  --shadow-md:0 8px 20px rgba(14,165,233,0.12);
  --shadow-lg:0 16px 40px rgba(14,165,233,0.18);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Plus Jakarta Sans',ui-sans-serif,system-ui,sans-serif;
  background:linear-gradient(135deg,var(--bg-start) 0%,var(--bg-end) 100%);
  color:var(--text);
  font-size:14px; line-height:1.6;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ‚îÄ‚îÄ Desktop frame wrapper ‚îÄ‚îÄ */
/* Di mobile: tidak ada perubahan. Di desktop: tampil seperti smartphone di tengah layar */
@media(min-width:768px){
  body{
    display:flex;
    align-items:flex-start;
    justify-content:center;
    min-height:100vh;
    padding:32px 0 48px;
    background:transparent;
    /* background-attachment:fixed dihapus ‚Äî tidak reliable di mobile/iOS */
  }

  /* Background dekoratif pakai pseudo-element fixed agar TIDAK ikut scroll */
  body::after{
    content:'';
    position:fixed;
    inset:0;
    z-index:-1;
    background:
      radial-gradient(circle at 20% 20%, rgba(14,165,233,0.12) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(139,92,246,0.1) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(6,182,212,0.06) 0%, transparent 70%),
      linear-gradient(135deg,#e0f2fe 0%,#f0f9ff 50%,#ede9fe 100%);
    pointer-events:none;
  }

  /* Label "Mobile App" di atas frame ‚Äî selalu di atas semua elemen termasuk modal */
  body::before{
    content:'üì± SiMERY ‚Äî Mobile App Preview';
    position:fixed;top:0;left:0;right:0;
    height:32px;
    display:flex;align-items:center;justify-content:center;
    font-family:'Plus Jakarta Sans',ui-sans-serif,system-ui,sans-serif;
    font-size:11px;font-weight:700;letter-spacing:0.04em;
    color:rgba(3,105,161,0.6);
    background:rgba(240,249,255,0.92);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    border-bottom:1px solid rgba(14,165,233,0.12);
    z-index:99999;
    pointer-events:none;
  }
}

/* ‚îÄ‚îÄ Shell ‚îÄ‚îÄ */
.app{width:100%;min-height:100vh;display:flex;flex-direction:column;background:#fff}

/* [FIX #8] Skeleton loading state ‚Äî sembunyikan konten saat inisialisasi */
.app.app-loading main { opacity: 0; }
.app main { opacity: 1; transition: opacity 0.25s ease; }

@media(min-width:768px){
  .app{
    /* Lebar 560px ‚Äî nyaman di desktop, tetap proporsional untuk konten mobile.
       Lebih intuitif dari 16:10 murni karena mengikuti bentuk HP nyata. */
    width:560px;
    min-height:100vh;
    max-height:none;
    border-radius:0;
    box-shadow:
      0 0 0 1px rgba(14,165,233,0.15),
      0 8px 32px rgba(14,165,233,0.15),
      0 32px 80px rgba(3,105,161,0.12),
      0 0 0 8px rgba(255,255,255,0.6);
    position:relative;
    overflow:hidden;
    /* isolation:isolate membuat stacking context baru sehingga
       z-index elemen di dalam .app (header, modal, dll) tidak
       bisa menembus keluar dan menimpa body::before */
    isolation:isolate;
    height:auto;
  }
  /* Notch-style bar tipis di atas frame untuk estetika */
  .app::before{
    content:'';
    display:block;
    height:3px;
    background:linear-gradient(90deg,var(--accent-1),var(--accent-2),var(--accent-3));
    flex-shrink:0;
  }
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
@keyframes gradShift{
  0%  {background-position:0% 50%}
  50% {background-position:100% 50%}
  100%{background-position:0% 50%}
}
.header{
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2),var(--accent-3),var(--accent-1));
  background-size:300% 300%;
  animation:gradShift 8s ease infinite;
  padding:16px;
  display:flex; align-items:center; gap:12px;
  position:sticky; top:0; z-index:100;
  box-shadow:0 4px 20px rgba(14,165,233,0.2);
}

.brand{display:flex;gap:12px;align-items:center;flex:1;min-width:0;position:relative;z-index:1}
.logo{
  width:48px;height:48px;border-radius:14px;
  background:rgba(255,255,255,0.2);
  display:flex;align-items:center;justify-content:center;
  font-size:22px;flex-shrink:0;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  border:1px solid rgba(255,255,255,0.25);
}
.title{font-weight:800;font-size:1.1rem;color:#fff;line-height:1.2;letter-spacing:-0.02em;cursor:pointer;user-select:none;}
.subtitle{font-size:0.78rem;color:rgba(255,255,255,0.85);margin-top:1px;font-weight:500}
.header-auth{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
#syncStatus{font-size:11px;color:rgba(255,255,255,0.7);text-align:right;min-height:14px;white-space:nowrap}
.g_id_signin{display:flex;align-items:center;justify-content:flex-end}
.g_id_signin > div > div{box-shadow:none!important}
#connectDriveBtn,#logoutBtn{
  font-family:inherit;cursor:pointer;border-radius:10px;
  font-size:12px;font-weight:700;padding:7px 14px;
  border:1.5px solid rgba(255,255,255,0.35);
  transition:background 0.2s,transform 0.15s,box-shadow 0.2s; white-space:nowrap;
  letter-spacing:0.01em;
}
#connectDriveBtn{background:rgba(255,255,255,0.2);color:#fff;display:none}
#connectDriveBtn:hover{background:rgba(255,255,255,0.32);transform:translateY(-1px)}
#logoutBtn{background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.95);display:none}
#logoutBtn:hover{background:rgba(255,255,255,0.25);transform:translateY(-1px)}

/* ‚îÄ‚îÄ Login overlay animated gradient ‚îÄ‚îÄ */
#loginOverlay{
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2),var(--accent-3),var(--accent-1));
  background-size:300% 300%;
  animation:gradShift 8s ease infinite;
}

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
.tabs{
  display:flex;gap:6px;margin-bottom:20px;
  background:#ffffff;
  border:2px solid rgba(14,165,233,0.1);
  border-radius:var(--radius-lg);padding:5px;
  box-shadow:0 2px 12px rgba(14,165,233,0.08);
}
.tab{
  flex:1;min-width:0;padding:7px 2px;border-radius:var(--radius);border:none;
  background:transparent;font-family:inherit;
  color:var(--muted);cursor:pointer;text-align:center;
  transition:all 0.2s ease;
  display:flex;flex-direction:column;align-items:center;gap:3px;
  overflow:hidden;position:relative;
  -webkit-tap-highlight-color:transparent;
}
.tab:active{transform:scale(0.95)}
.tab-icon{width:18px;height:18px;line-height:1;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.tab-label{
  font-size:9px;font-weight:700;line-height:1.3;
  white-space:normal;word-break:keep-all;overflow-wrap:normal;
  width:100%;text-align:center;
  text-transform:uppercase;letter-spacing:0.01em;
}
.tab.active{
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
  color:#fff;
  box-shadow:0 4px 12px rgba(14,165,233,0.3);
  transform:translateY(-1px);
}
.tab:not(.active):hover{
  background:var(--blue-light);
  color:var(--blue-dark);
  border-color:rgba(14,165,233,0.2);
}

/* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.stat{
  background:#ffffff;
  border:2px solid rgba(14,165,233,0.1);
  border-radius:var(--radius-lg);padding:18px 10px;text-align:center;
  transition:all 0.2s ease;
  position:relative;overflow:hidden;
}
.stat:hover{
  transform:translateY(-3px);
  box-shadow:0 8px 20px rgba(14,165,233,0.12);
  border-color:rgba(14,165,233,0.25);
}
.stat .n{
  font-size:1.75rem;font-weight:800;line-height:1;margin-bottom:6px;letter-spacing:-0.03em;
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.stat .label{font-size:0.72rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.05em}

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
.search{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:stretch}
.search input{
  flex:1 1 100%;min-width:0;padding:12px 16px;
  border-radius:var(--radius);border:2px solid rgba(14,165,233,0.12);
  background:#ffffff;font-family:inherit;font-size:14px;color:var(--text);
  transition:all 0.2s ease;
}
.search input::placeholder{color:var(--muted);opacity:0.7}
.search input:focus{outline:none;border-color:var(--accent-1);box-shadow:0 0 0 3px rgba(14,165,233,0.1);background:#fff}
.search .btn,.search .btn-barcode{flex:1 1 calc(50% - 5px);min-width:110px}
@media(min-width:640px){
  .search{flex-wrap:nowrap}
  .search input{flex:1}
  .search .btn,.search .btn-barcode{flex:initial}
}

/* ‚îÄ‚îÄ Global inputs ‚îÄ‚îÄ */
input,select,button,textarea{font-family:inherit;font-size:14px;outline:none}
input,select,textarea{transition:all 0.2s ease}
input:focus,select:focus,textarea:focus{
  border-color:var(--accent-1);
  box-shadow:0 0 0 3px rgba(14,165,233,0.1);
}
textarea{resize:vertical;min-height:80px}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn{
  display:inline-flex;align-items:center;gap:8px;justify-content:center;
  border-radius:var(--radius);padding:11px 18px;border:none;
  cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;
  transition:all 0.2s ease;
  text-decoration:none;white-space:nowrap;letter-spacing:0.01em;
}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 14px rgba(0,0,0,0.12)}
.btn:active{transform:translateY(0);opacity:0.9}
.btn.ghost{
  background:#ffffff;border:2px solid rgba(14,165,233,0.15);
  color:var(--muted);
}
.btn.ghost:hover{background:#ffffff;border-color:rgba(14,165,233,0.3);color:var(--text)}
.btn.primary{
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
  color:#fff;box-shadow:0 2px 8px rgba(14,165,233,0.25);
}
.btn.primary:hover{box-shadow:0 6px 18px rgba(14,165,233,0.35)}
.btn.orange{
  background:linear-gradient(135deg,#f97316,#fb923c);
  color:#fff;box-shadow:0 2px 8px rgba(249,115,22,0.25);
}
.btn.orange:hover{box-shadow:0 6px 18px rgba(249,115,22,0.35)}
.btn.green{
  background:linear-gradient(135deg,#10b981,#34d399);
  color:#fff;box-shadow:0 2px 8px rgba(16,185,129,0.25);
}
.btn.green:hover{box-shadow:0 6px 18px rgba(16,185,129,0.35)}
.btn.danger{
  background:linear-gradient(135deg,var(--danger),#f87171);
  color:#fff;box-shadow:0 2px 8px rgba(239,68,68,0.25);
}
.btn.danger:hover{box-shadow:0 6px 18px rgba(239,68,68,0.35)}

/* ‚îÄ‚îÄ Barcode button ‚îÄ‚îÄ */
.btn-barcode{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:11px 18px;border-radius:var(--radius);border:none;
  cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;
  background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff;
  box-shadow:0 2px 8px rgba(139,92,246,0.3);
  transition:all 0.2s ease;white-space:nowrap;letter-spacing:0.01em;
}
.btn-barcode:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(139,92,246,0.38)}
.btn-barcode:active{transform:translateY(0);opacity:0.9}
.btn-barcode .btn-barcode-text{
  display:flex;flex-direction:column;align-items:flex-start;
  line-height:1.15;gap:0;
}
.btn-barcode .btn-barcode-text span{display:block;}

/* ‚îÄ‚îÄ List & Card ‚îÄ‚îÄ */
.list{display:grid;gap:14px}
.card{
  background:#ffffff;
  border:2px solid rgba(14,165,233,0.1);
  border-radius:var(--radius-lg);padding:18px;
  display:flex;flex-direction:column;
  transition:all 0.2s ease;
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(14,165,233,0.12);
  border-color:rgba(14,165,233,0.22);
}
.card .top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:10px}
.card h3{font-size:1.05rem;font-weight:700;color:var(--text);letter-spacing:-0.01em}
.meta{color:var(--text-2);font-size:0.875rem;line-height:1.6;font-weight:500}
.actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}

/* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
.badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:5px 12px;border-radius:20px;
  font-weight:700;font-size:0.7rem;letter-spacing:0.05em;
  text-transform:uppercase;white-space:nowrap;flex-shrink:0;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.badge.available{
  background:linear-gradient(135deg,#10b981,#34d399);
  color:#fff;
}
.badge.low{
  background:linear-gradient(135deg,#f59e0b,#fbbf24);
  color:#fff;
}
.badge.empty{
  background:linear-gradient(135deg,#ef4444,#f87171);
  color:#fff;
}

/* ‚îÄ‚îÄ Manage chip filters ‚îÄ‚îÄ */
.manage-chip{
  padding:5px 12px;border-radius:20px;border:1.5px solid rgba(14,165,233,0.18);
  background:#fff;font-family:inherit;font-size:12px;font-weight:600;
  color:var(--muted);cursor:pointer;
  transition:all 0.18s ease;white-space:nowrap;
  -webkit-tap-highlight-color:transparent;
}
.manage-chip:hover{border-color:var(--accent-1);color:var(--accent-1);background:var(--blue-light);}
.manage-chip.active{
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
  color:#fff;border-color:transparent;
  box-shadow:0 2px 8px rgba(14,165,233,0.3);
}
.manage-chip-warn.active{
  background:linear-gradient(135deg,var(--warning),#fbbf24) !important;
  box-shadow:0 2px 8px rgba(245,158,11,0.3) !important;
}
.manage-chip-danger.active{
  background:linear-gradient(135deg,var(--danger),#f87171) !important;
  box-shadow:0 2px 8px rgba(239,68,68,0.3) !important;
}

/* ‚îÄ‚îÄ Category dropdown custom ‚îÄ‚îÄ */
.manage-cat-select-wrap{
  position:relative;display:flex;align-items:center;
}
.manage-cat-icon{ display:none; }
.manage-cat-chevron{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  color:var(--muted);pointer-events:none;flex-shrink:0;
  display:flex;align-items:center;transition:transform 0.2s;
}
.manage-cat-select{
  width:100%;padding:9px 32px 9px 12px;
  border:1.5px solid rgba(14,165,233,0.15);
  border-radius:10px;
  background:#f8fafc;
  font-family:inherit;font-size:13px;font-weight:500;
  color:var(--text);cursor:pointer;
  appearance:none;-webkit-appearance:none;
  transition:all 0.18s ease;
}
.manage-cat-select:focus{
  outline:none;
  border-color:var(--accent-1);
  box-shadow:0 0 0 3px rgba(14,165,233,0.1);
  background:#fff;
}
.manage-cat-select:focus + .manage-cat-chevron,
.manage-cat-select-wrap:focus-within .manage-cat-chevron{
  transform:translateY(-50%) rotate(180deg);
  color:var(--accent-1);
}
.manage-cat-select option{ background:#fff; color:var(--text); font-weight:500; }

#manageListToggle:hover{background:linear-gradient(135deg,#e0f2fe,#bae6fd);}

/* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
.form{display:grid;gap:18px}
.form label{
  display:block;font-size:0.82rem;color:var(--muted);
  font-weight:700;letter-spacing:0.02em;
}
.form input,.form select,.form textarea{
  padding:12px 16px;border-radius:var(--radius);
  border:2px solid rgba(14,165,233,0.12);width:100%;margin-top:6px;
  background:#ffffff;font-family:inherit;font-size:14px;color:var(--text);
  transition:all 0.2s ease;
}
.form input:focus,.form select:focus,.form textarea:focus{
  background:#ffffff;outline:none;
  border-color:var(--accent-1);box-shadow:0 0 0 3px rgba(14,165,233,0.1);
}

/* ‚îÄ‚îÄ Barcode input group ‚îÄ‚îÄ */
.barcode-input-group{display:flex;gap:10px;align-items:stretch;margin-top:6px}
.barcode-input-group input{flex:1;margin-top:0}
.barcode-input-group .btn-barcode{flex-shrink:0;padding:12px 16px}

/* ‚îÄ‚îÄ Scanner modal ‚îÄ‚îÄ */
@keyframes scanLine{
  0%  {top:15%; opacity:0.9}
  50% {opacity:1}
  100%{top:85%; opacity:0.9}
}
@keyframes cornerPulse{
  0%,100%{opacity:1}
  50%{opacity:0.5}
}
#scannerModal{
  position:fixed;inset:0;display:none;
  align-items:flex-end;justify-content:center;
  background:rgba(2,32,58,0.85);z-index:3000;
  backdrop-filter:blur(8px);
}
#scannerModal .modal-card{
  width:100%;max-width:440px;
  padding:0;
  border-radius:24px 24px 0 0;
  background:#0a1628;
  overflow:hidden;display:flex;flex-direction:column;
  box-shadow:0 -8px 40px rgba(14,165,233,0.3);
  animation:slideUp 0.32s cubic-bezier(0.34,1.2,0.64,1) both;
}
@keyframes slideUp{
  from{transform:translateY(100%);opacity:0}
  to  {transform:translateY(0);opacity:1}
}
#scannerModal .modal-card::before{
  content:'';display:block;width:40px;height:4px;
  background:rgba(255,255,255,0.18);border-radius:2px;
  margin:12px auto 0;flex-shrink:0;
}
.scanner-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px 10px;
}
.scanner-title{
  display:flex;align-items:center;gap:9px;
  font-size:15px;font-weight:700;color:#fff;
}
.scanner-title-icon{
  width:32px;height:32px;border-radius:9px;
  background:linear-gradient(135deg,var(--accent-1),var(--accent-3));
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.scanner-close-btn{
  width:32px;height:32px;border-radius:50%;
  background:rgba(255,255,255,0.1);border:none;
  color:rgba(255,255,255,0.7);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background 0.15s;font-family:inherit;font-size:18px;line-height:1;
}
.scanner-close-btn:hover{background:rgba(255,255,255,0.2)}
.scanner-hint{
  text-align:center;font-size:12px;color:rgba(255,255,255,0.45);
  padding:0 20px 10px;line-height:1.5;
}
.scanner-viewport{
  position:relative;
  margin:0 16px 16px;
  border-radius:16px;overflow:hidden;
  background:#000;
  aspect-ratio:1/1;
  max-height:58vw;
}

/* ‚îÄ‚îÄ html5-qrcode suppression ‚îÄ‚îÄ */
#reader{
  width:100%!important;height:100%!important;
  border:none!important;padding:0!important;
  background:transparent;position:relative;
}
#reader select,
#reader #html5-qrcode-select-camera,
#reader span[id*="select-camera"],
#reader > div:not([id]) > span,
#reader > span,
#reader label,
#reader p,
#reader img[alt="Info icon"],
#reader img[alt="Camera based scan"],
#reader img[alt="File based scan"],
#reader button[id*="html5"],
#reader #html5-qrcode-button-camera-start,
#reader #html5-qrcode-button-camera-stop,
#reader #html5-qrcode-button-file-selection,
#reader #html5-qrcode-anchor-scan-type-change,
#reader #html5-qrcode-header,
#reader > div:has(> select),
#reader > div:has(> button),
#reader > section > div:first-child,
#reader div[id*="permission"],
#reader div[id*="header"] {
  display:none!important;
  visibility:hidden!important;
  height:0!important;
  overflow:hidden!important;
  pointer-events:none!important;
}
#reader video{
  width:100%!important;height:100%!important;
  object-fit:cover!important;
  display:block!important;
  border:none!important;
}
#reader canvas{
  position:absolute!important;
  top:0!important;left:0!important;
  width:100%!important;height:100%!important;
  opacity:0!important;
  pointer-events:none!important;
}
/* Make the inner section fill container */
#reader > section,
#reader > div{
  width:100%!important;height:100%!important;
  border:none!important;padding:0!important;margin:0!important;
}

/* ‚îÄ‚îÄ Our custom scan frame overlay ‚îÄ‚îÄ */
.scan-frame-overlay{
  position:absolute;inset:0;pointer-events:none;z-index:10;
}
.scan-frame-overlay::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(
    ellipse 54% 54% at 50% 50%,
    transparent 52%,
    rgba(0,0,0,0.58) 100%
  );
}
.scan-line{
  position:absolute;left:22%;right:22%;height:2px;
  background:linear-gradient(90deg,transparent,rgba(14,165,233,0.9),transparent);
  border-radius:1px;
  animation:scanLine 2s ease-in-out infinite;
  z-index:12;
}
.scan-corners{
  position:absolute;
  top:50%;left:50%;
  width:52%;height:52%;
  transform:translate(-50%,-50%);
  z-index:11;
}
.scan-corners span{
  position:absolute;width:22px;height:22px;
  border-color:var(--accent-1);border-style:solid;
  border-width:0;
  animation:cornerPulse 2s ease-in-out infinite;
}
.scan-corners span:nth-child(1){top:0;left:0;    border-top-width:3px;border-left-width:3px;  border-radius:4px 0 0 0}
.scan-corners span:nth-child(2){top:0;right:0;   border-top-width:3px;border-right-width:3px; border-radius:0 4px 0 0}
.scan-corners span:nth-child(3){bottom:0;left:0; border-bottom-width:3px;border-left-width:3px;  border-radius:0 0 0 4px}
.scan-corners span:nth-child(4){bottom:0;right:0;border-bottom-width:3px;border-right-width:3px; border-radius:0 0 4px 0}

.scanner-status{
  display:flex;align-items:center;gap:7px;justify-content:center;
  padding:8px 20px 18px;
}
.scanner-status-dot{
  width:7px;height:7px;border-radius:50%;
  background:var(--accent-1);
  animation:pulse 1.4s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{box-shadow:0 0 0 0 rgba(14,165,233,0.5)}
  50%{box-shadow:0 0 0 5px rgba(14,165,233,0)}
}
.scanner-status-text{
  font-size:12px;font-weight:600;
  color:rgba(255,255,255,0.6);letter-spacing:0.02em;
}
#scannerModal .modal-actions{display:none!important}

@media(min-width:480px){
  #scannerModal{align-items:center}
  #scannerModal .modal-card{border-radius:24px;max-width:380px;}
  .scanner-viewport{max-height:none;aspect-ratio:1/1}
}
@media(max-height:500px) and (orientation:landscape){
  .scanner-viewport{aspect-ratio:16/9;max-height:48vh}
}

/* ‚îÄ‚îÄ Notifications / Toast ‚îÄ‚îÄ */
@keyframes toastIn{
  from{opacity:0;transform:translateY(-12px) scale(0.96)}
  to  {opacity:1;transform:translateY(0)    scale(1)}
}
@keyframes toastOut{
  from{opacity:1;transform:translateY(0) scale(1)}
  to  {opacity:0;transform:translateY(-8px) scale(0.97)}
}
.notification{
  position:fixed;top:76px;right:16px;left:16px;
  margin:0 auto;max-width:360px;
  padding:14px 16px;
  border-radius:14px;
  background:#ffffff;
  box-shadow:0 8px 32px rgba(0,0,0,0.15);
  z-index:5000;color:#fff;
  opacity:0;
  animation:toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
/* Pada desktop, pastikan notifikasi muncul di dalam frame 560px yang centered */
@media(min-width:768px){
  .notification{
    left:calc(50% - 280px + 16px);
    right:auto;
    width:calc(560px - 32px);
    max-width:calc(560px - 32px);
    transform:none;
  }
  .notification.hiding{
    transform:translateY(-8px) scale(0.97);
  }
}
.notification.hiding{animation:toastOut 0.22s ease forwards}
.notification.show{opacity:1}
.notification.success{background:linear-gradient(135deg,#10b981,#059669);box-shadow:0 8px 32px rgba(16,185,129,0.3)}
.notification.error  {background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 8px 32px rgba(239,68,68,0.3)}
.notification.warning{background:linear-gradient(135deg,#f59e0b,#d97706);box-shadow:0 8px 32px rgba(245,158,11,0.3)}
.notification.info   {background:linear-gradient(135deg,#3b82f6,#2563eb);box-shadow:0 8px 32px rgba(59,130,246,0.3)}
.notification-content{display:flex;align-items:flex-start;gap:12px}
.notification-icon{
  flex-shrink:0;width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;font-size:14px;
  background:rgba(255,255,255,0.2);
}
.notification-text{flex:1}
.notification-title{font-weight:700;font-size:14px;color:#fff;line-height:1.3;margin-bottom:2px}
.notification-message{font-size:12px;color:rgba(255,255,255,0.88);line-height:1.4}
.notification-close{
  flex-shrink:0;width:24px;height:24px;border-radius:50%;border:none;
  background:rgba(255,255,255,0.2);color:#fff;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:14px;line-height:1;
  transition:background 0.15s;padding:0;font-family:inherit;
}
.notification-close:hover{background:rgba(255,255,255,0.32)}
.notification.single-line .notification-content{align-items:center}
.notification.single-line .notification-title{margin-bottom:0}
@media(max-width:480px){
  .notification{right:12px;left:12px;max-width:none;top:72px}
}

/* ‚îÄ‚îÄ Stock-out form ‚îÄ‚îÄ */
.stock-out-form{
  background:#ffffff;
  border:2px solid rgba(14,165,233,0.1);
  border-radius:var(--radius-lg);padding:20px;
  box-shadow:0 2px 12px rgba(14,165,233,0.06);
}
.stock-out-title{
  display:flex;align-items:center;gap:8px;
  margin-bottom:16px;font-size:1.05rem;color:var(--accent-1);font-weight:800;
}

/* ‚îÄ‚îÄ Selected item card ‚îÄ‚îÄ */
.selected-item-card{
  background:#f8faff;border:2px solid rgba(14,165,233,0.12);
  border-radius:var(--radius);padding:12px 16px;
  display:flex;justify-content:space-between;align-items:center;gap:12px;
  transition:all 0.2s ease;
}
.selected-item-card:hover{border-color:rgba(14,165,233,0.25);box-shadow:0 4px 12px rgba(14,165,233,0.08)}
.selected-item-info{flex:1;min-width:0}
.selected-item-name{font-weight:700;font-size:14px;color:var(--text);margin-bottom:2px}
.selected-item-meta{font-size:12px;color:var(--muted)}
.selected-item-actions{display:flex;gap:8px;align-items:center}
.btn-remove{
  background:linear-gradient(135deg,#ef4444,#f87171);color:#fff;
  border:none;padding:6px 14px;border-radius:8px;
  font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;
  transition:all 0.2s ease;box-shadow:0 2px 6px rgba(239,68,68,0.25);
}
.btn-remove:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(239,68,68,0.35)}

/* ‚îÄ‚îÄ Suggestions dropdown ‚îÄ‚îÄ */
.stock-out-search-wrapper{position:relative}
.suggestions-dropdown{
  position:absolute;top:100%;left:0;right:0;
  background:#ffffff;
  border:2px solid rgba(14,165,233,0.12);
  border-radius:var(--radius);margin-top:4px;
  max-height:280px;overflow-y:auto;
  box-shadow:0 8px 24px rgba(14,165,233,0.15);
  z-index:1000;display:none;
}
.suggestions-dropdown.show{display:block}
.suggestion-item{
  padding:12px 16px;cursor:pointer;
  border-bottom:1px solid rgba(14,165,233,0.06);
  transition:background 0.15s;
}
.suggestion-item:last-child{border-bottom:none}
.suggestion-item:hover{background:#f0f9ff}
.suggestion-item-name{font-weight:700;color:var(--text);font-size:14px;margin-bottom:4px}
.suggestion-item-meta{font-size:12px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap}
.suggestion-item-stock{display:inline-flex;align-items:center;gap:3px}
.suggestion-item-stock.low{color:var(--danger);font-weight:700}
.suggestion-item-stock.available{color:var(--success);font-weight:700}
.suggestion-no-results{padding:16px;text-align:center;color:var(--muted);font-size:13px}

/* ‚îÄ‚îÄ Signature canvas ‚îÄ‚îÄ */
#signatureCanvas{
  background:#ffffff;border:2px dashed rgba(14,165,233,0.3);
  display:block;width:100%;height:auto;
  cursor:crosshair;touch-action:none;transition:border-color 0.2s;
  border-radius:var(--radius);
}
#signatureCanvas:hover{border-color:var(--accent-1)}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media(max-width:480px){
  .modal-actions{flex-direction:column}
  .modal-actions button{width:100%}
}

/* ‚îÄ‚îÄ Extra polish ‚îÄ‚îÄ */
.main{padding:16px;flex:1;background:transparent}
.view.hidden{display:none}
.btn-barcode,.btn-barcode *{-webkit-tap-highlight-color:transparent}
select option{background:#ffffff;color:var(--text)}
@keyframes slideUpModal{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
#deleteConfirmInput:focus{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,0.12)}
</style>
  <!-- [FIX-A] html5-qrcode & jsPDF DIHAPUS dari sini ‚Äî dimuat lazy saat dibutuhkan -->
</head>

<body>
  <!-- Login overlay: shows when not authenticated. Data stays intact (offline-first). -->
  <div id="loginOverlay" style="display:none;position:fixed;inset:0;z-index:9000;flex-direction:column;align-items:center;justify-content:center;padding:24px;overflow:hidden;touch-action:none;">
    <div style="background:rgba(255,255,255,0.12);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);border-top:1px solid rgba(255,255,255,0.55);border-left:1px solid rgba(255,255,255,0.35);border-right:1px solid rgba(255,255,255,0.15);border-bottom:1px solid rgba(255,255,255,0.1);border-radius:28px;padding:36px 28px;max-width:340px;width:100%;box-shadow:0 32px 64px rgba(3,105,161,0.35),0 2px 0 rgba(255,255,255,0.4) inset,0 -1px 0 rgba(0,0,0,0.06) inset;">
      <div style="text-align:center;margin-bottom:24px;">
        <div style="font-size:48px;margin-bottom:12px;">üì¶</div>
        <div style="font-weight:800;font-size:1.4rem;color:#fff;letter-spacing:-0.02em;text-shadow:0 1px 8px rgba(0,0,0,0.2);">SiMERY</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.7);margin-top:5px;font-weight:500;">Manajemen Inventory ¬∑ Twin Insani, S.Kom</div>
      </div>
      <div style="background:rgba(255,255,255,0.92);border:1px solid rgba(255,255,255,0.6);border-radius:16px;padding:14px 16px;margin-bottom:24px;">
        <div style="font-size:13px;font-weight:800;color:#0369a1;margin-bottom:4px;">üì± Mode Offline Tersedia</div>
        <div style="font-size:12px;color:#0284c7;line-height:1.6;font-weight:500;">Data tersimpan di perangkat ini. Login untuk mengaktifkan sinkronisasi Google Drive.</div>
      </div>
      <div id="overlaySigninBtn" style="display:flex;justify-content:center;margin-bottom:14px;"></div>
      <div id="overlayOfflineBtn" style="display:none;text-align:center;">
        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:10px;">atau</div>
        <button onclick="dismissOverlay()" style="width:100%;padding:12px 16px;border-radius:12px;border:none;background:rgba(255,255,255,0.92);font-family:inherit;font-size:13px;font-weight:700;color:#0369a1;cursor:pointer;transition:all 0.2s ease;letter-spacing:0.01em;box-shadow:0 2px 12px rgba(0,0,0,0.1);">Mode Offline</button>
      </div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="logo">üì¶</div>
        <div>
          <div class="title" onclick="showOverlay()">SiMERY</div>
          <div class="subtitle">Aplikasi Manajemen Inventory</div>
        </div>
      </div>
      <div class="header-auth">
  <div id="g_id_onload"
       data-client_id="1030288606883-712ik0rkv9jkp0meivlv80jkkaksl09f.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"
       data-use_fedcm_for_prompt="false"
       data-itp_support="true"
       data-cancel_on_tap_outside="false">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="medium"
       data-theme="outline"
       data-text="signin"
       data-shape="pill">
  </div>
  <button id="connectDriveBtn">‚òÅÔ∏è Sambungkan Drive</button>
  <button id="logoutBtn">Keluar</button>
  <div id="syncStatus"></div>
</div>

    </header>

    <main class="main">
      <nav class="tabs">
        <button class="tab active" data-tab="dashboard">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>
          <span class="tab-label">Dasbor</span>
        </button>
        <button class="tab" data-tab="manage">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zm0 12H4V9h16v10zM13 5H11V3H9v2H7V3H5v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3h-2v2h-2V3h-2v2z"/></svg></span>
          <span class="tab-label">Kelola Barang</span>
        </button>
        <button class="tab" data-tab="stockOut">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14zM12 19l5-4-5-4v3H9v2h3v3z"/></svg></span>
          <span class="tab-label">Keluarkan Stok</span>
        </button>
        <button class="tab" data-tab="history">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 1 1 2.05 4.95L6.63 18.37A9 9 0 1 0 13 3zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8H12z"/></svg></span>
          <span class="tab-label">Riwayat Transaksi</span>
        </button>
        <button class="tab" data-tab="dataManagement">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 4.02 2 6.5v11C2 19.98 6.48 22 12 22s10-2.02 10-4.5v-11C22 4.02 17.52 2 12 2zm8 15.5c0 1.38-3.58 2.5-8 2.5s-8-1.12-8-2.5V15c1.78 1.18 4.77 1.75 8 1.75s6.22-.57 8-1.75v2.5zm0-5c0 1.38-3.58 2.5-8 2.5s-8-1.12-8-2.5V10c1.78 1.18 4.77 1.75 8 1.75s6.22-.57 8-1.75v2.5zm-8-2.25C7.58 10.25 4 9.13 4 7.75S7.58 5.25 12 5.25s8 1.12 8 2.5-3.58 2.25-8 2.25z"/></svg></span>
          <span class="tab-label">Manajemen Data</span>
        </button>
      </nav>

      <!-- Dashboard -->
      <section class="view" id="dashboard">
        <div class="stats">
          <div class="stat"><div class="n" id="totalN">0</div><div class="label">Total Barang</div></div>
          <div class="stat"><div class="n" id="stockN">0</div><div class="label">Total Stok</div></div>
          <div class="stat"><div class="n" id="lowN">0</div><div class="label">Stok Rendah (‚â§5)</div></div>
        </div>

        <div class="search">
          <input id="q" placeholder="Cari barang..." />
          <button class="btn ghost" id="clearSearch">Bersihkan</button>
        </div>

        <div class="list" id="items"></div>
      </section>

      <!-- Manage -->
      <section class="view hidden" id="manage">
        <div class="meta" style="font-weight:bold;margin-bottom:8px;font-size:1.1em;color:var(--blue-dark);">üì¶ Tambah Barang Baru</div>
        <div style="background:#ffffff;border:1.5px solid var(--border);padding:16px;border-radius:16px;box-shadow:var(--shadow-sm);margin-bottom:16px;">
          <form id="addForm" class="form">
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C13.1 2 14 2.9 14 4V6H20C20.6 6 21 6.4 21 7S20.6 8 20 8H14V10C14 11.1 13.1 12 12 12S10 11.1 10 10V8H4C3.4 8 3 7.6 3 7S3.4 6 4 6H10V4C10 2.9 10.9 2 12 2M12 14C13.1 14 14 14.9 14 16V18H20C20.6 18 21 18.4 21 19S20.6 20 20 20H14V22C14 23.1 13.1 24 12 24S10 23.1 10 22V20H4C3.4 20 3 19.6 3 19S3.4 18 4 18H10V16C10 14.9 10.9 14 12 14Z"/>
                </svg>
                Nama Barang
              </div>
              <input id="name" placeholder="Contoh: Pulpen" required />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2M6.5 12.5L7.5 16.5L11.5 17.5L7.5 18.5L6.5 22.5L5.5 18.5L1.5 17.5L5.5 16.5L6.5 12.5M17.5 12.5L18.5 16.5L22.5 17.5L18.5 18.5L17.5 22.5L16.5 18.5L12.5 17.5L16.5 16.5L17.5 12.5"/>
                </svg>
                Kategori
              </div>
              <select id="category" required>
                <option value="">Pilih Kategori</option>
                <option value="Alat Kebersihan">Alat Kebersihan</option>
                <option value="Bahan Kebersihan">Bahan Kebersihan</option>
                <option value="Alat Tulis Kantor">Alat Tulis Kantor</option>
                <option value="Alat Kelistrikan">Alat Kelistrikan</option>
                <option value="Alat Olahraga">Alat Olahraga</option>
                <option value="Alat Kesehatan">Alat Kesehatan</option>
              </select>
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 4V2C7 1.45 7.45 1 8 1S9 1.45 9 2V4H15V2C15 1.45 15.45 1 16 1S17 1.45 17 2V4H20C21.11 4 22 4.89 22 6V20C22 21.11 21.11 22 20 22H4C2.89 22 2 21.11 2 20V6C2 4.89 2.89 4 4 4H7M4 8V20H20V8H4M6 10H8V12H6V10M10 10H12V12H10V10M14 10H16V12H14V10M6 14H8V16H6V14M10 14H12V16H10V14M14 14H16V16H14V14"/>
                </svg>
                Stok Awal
              </div>
              <input id="stock" type="number" min="0" value="0" />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h1v12H7V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6z"/>
                </svg>
                Barcode (Opsional)
              </div>
              <div class="barcode-input-group">
                <input id="barcode" placeholder="Scan atau ketik barcode" />
                <button type="button" class="btn-barcode" id="scanBarcodeBtn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h1v12H7V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6z"/>
                  </svg>
                  <span class="btn-barcode-text"><span>Scan</span><span>Barcode</span></span>
                </button>
              </div>
            </label>
            
            <div class="actions" style="margin-top:16px;">
              <button class="btn primary" type="submit">Tambah Barang</button>
            </div>
          </form>
        </div>
        
        <!-- Collapsible Daftar Barang -->
        <div id="manageListSection" style="border:1.5px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);">
          <!-- Header toggle -->
          <button id="manageListToggle" type="button" onclick="toggleManageList()" style="
            width:100%;display:flex;align-items:center;justify-content:space-between;
            padding:14px 16px;background:linear-gradient(135deg,var(--blue-light),#e0f2fe);
            border:none;cursor:pointer;font-family:inherit;text-align:left;
            transition:background 0.2s;gap:10px;
            border-bottom:1.5px solid transparent;
          ">
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(14,165,233,0.25);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
              </div>
              <div>
                <div style="font-weight:700;font-size:14px;color:var(--blue-dark);">Daftar Barang yang Ada</div>
                <div style="font-size:11px;color:var(--muted);margin-top:1px;">Klik untuk lihat & kelola barang</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
              <span id="manageListBadge" style="
                background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
                color:#fff;font-size:11px;font-weight:700;
                padding:3px 10px;border-radius:20px;
                box-shadow:0 2px 6px rgba(14,165,233,0.3);
              ">0 barang</span>
              <svg id="manageListChevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--blue-dark)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="transition:transform 0.25s ease;flex-shrink:0;">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
          </button>

          <!-- Collapsible body -->
          <div id="manageListBody" style="max-height:0;overflow:hidden;transition:max-height 0.38s cubic-bezier(0.25,0.46,0.45,0.94);">
            <div style="padding:14px 14px 6px;background:#fff;border-top:1.5px solid rgba(14,165,233,0.1);">

              <!-- Search -->
              <div style="display:flex;gap:8px;margin-bottom:10px;">
                <div style="position:relative;flex:1;">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="var(--muted)" style="position:absolute;left:11px;top:50%;transform:translateY(-50%);pointer-events:none;flex-shrink:0;">
                    <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                  </svg>
                  <input id="manageSearch" placeholder="Cari nama barang..." style="
                    width:100%;padding:10px 12px 10px 34px;
                    border:1.5px solid rgba(14,165,233,0.15);border-radius:10px;
                    background:#f8fafc;font-family:inherit;font-size:13px;color:var(--text);
                    transition:all 0.2s;
                  " />
                </div>
                <button class="btn ghost" id="clearManageSearch" style="padding:10px 12px;font-size:12px;flex-shrink:0;">
                  <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg>
                </button>
              </div>

              <!-- Filter baris 1: stok chips -->
              <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
                <button class="manage-chip active" data-manage-filter="all" type="button">Semua</button>
                <button class="manage-chip" data-manage-filter="available" type="button">‚úì Tersedia</button>
                <button class="manage-chip manage-chip-warn" data-manage-filter="low" type="button">‚ö† Hampir Habis</button>
                <button class="manage-chip manage-chip-danger" data-manage-filter="empty" type="button">‚úï Stok Habis</button>
              </div>

              <!-- Filter baris 2: dropdown kategori -->
              <div class="manage-cat-select-wrap" style="margin-bottom:12px;">
                <select id="manageCategoryDropdown" class="manage-cat-select">
                  <option value="">Semua Kategori</option>
                </select>
                <div class="manage-cat-chevron">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
              </div>

            </div>
            <div style="padding:0 14px 14px;background:#fff;">
              <div class="list" id="manageList"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Stock Out - Multi-item Selection -->
      <section class="view hidden" id="stockOut">
        <div class="stock-out-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2M6.5 12.5L7.5 16.5L11.5 17.5L7.5 18.5L6.5 22.5L5.5 18.5L1.5 17.5L5.5 16.5L6.5 12.5M17.5 12.5L18.5 16.5L22.5 17.5L18.5 18.5L17.5 22.5L16.5 18.5L12.5 17.5L16.5 16.5L17.5 12.5"/>
          </svg>
          Keluarkan Stok Barang
        </div>
        
        <div class="stock-out-form">
          <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:2px dashed var(--border);">
            <div style="font-weight:600;margin-bottom:12px;color:var(--blue-dark);">Tambah Barang ke Daftar</div>
            <div class="form" style="gap:12px;">
              <label>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C13.1 2 14 2.9 14 4V6H20C20.6 6 21 6.4 21 7S20.6 8 20 8H14V10C14 11.1 13.1 12 12 12S10 11.1 10 10V8H4C3.4 8 3 7.6 3 7S3.4 6 4 6H10V4C10 2.9 10.9 2 12 2M12 14C13.1 14 14 14.9 14 16V18H20C20.6 18 21 18.4 21 19S20.6 20 20 20H14V22C14 23.1 13.1 24 12 24S10 23.1 10 22V20H4C3.4 20 3 19.6 3 19S3.4 18 4 18H10V16C10 14.9 10.9 14 12 14Z"/>
                  </svg>
                  Pilih Barang
                </div>
                
                <div class="stock-out-search-wrapper">
                  <div style="display:flex;gap:8px;">
                    <input id="stockOutSearch" placeholder="Ketik nama / kategori / barcode..." autocomplete="off" style="flex:1;">
                    <button type="button" class="btn-barcode" id="scanStockOutBtn" style="flex-shrink:0;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h1v12H7V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6z"/>
                      </svg>
                      <span class="btn-barcode-text"><span>Scan</span><span>Barcode</span></span>
                    </button>
                  </div>
                  <div id="stockOutSuggestions" class="suggestions-dropdown"></div>
                </div>
              </label>
              
              <label>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 7H5V5H19V7ZM19 11H5V9H19V11ZM19 15H5V13H19V15ZM19 19H5V17H19V19Z"/>
                  </svg>
                  Jumlah
                </div>
                <input id="stockOutQty" type="number" min="1" placeholder="Masukkan jumlah" />
              </label>
              
              <button class="btn green" type="button" id="addItemToList">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                </svg>
                Tambah ke Daftar
              </button>
            </div>
          </div>
          
          <div id="selectedItemsList" style="margin-bottom:20px;display:none;">
            <div style="font-weight:600;margin-bottom:12px;color:var(--blue-dark);display:flex;justify-content:space-between;align-items:center;">
              <span>Daftar Barang yang Akan Dikeluarkan</span>
              <span style="font-size:12px;color:var(--text-2);font-weight:500;" id="totalItemsCount">0 item</span>
            </div>
            <div id="selectedItemsContainer" style="display:grid;gap:8px;margin-bottom:16px;"></div>
          </div>
          
          <form id="stockOutForm" class="form">
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4z"/>
                </svg>
                Penerima
              </div>
              <input id="stockOutRecipient" placeholder="Nama penerima barang" required />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M14,10H12V8H14M14,16H12V12H14M20,8H17.19C16.74,7.22 16.12,6.55 15.37,6.04L17,4.41L15.59,3L13.42,5.17C12.96,5.06 12.5,5 12,5C11.5,5 11.04,5.06 10.59,5.17L8.41,3L7,4.41L8.62,6.04C7.88,6.55 7.26,7.22 6.81,8H4V10H6.09C6.04,10.33 6,10.66 6,11V12H4V14H6V15C6,15.34 6.04,15.67 6.09,16H4V18H6.81C7.85,19.79 9.78,21 12,21C14.22,21 16.15,19.79 17.19,18H20V16H17.91C17.96,15.67 18,15.34 18,15V14H20V12H18V11C18,10.66 17.96,10.33 17.91,10H20V8Z"/>
                </svg>
                Keterangan
              </div>
              <textarea id="stockOutNotes" placeholder="Keterangan tambahan (opsional)"></textarea>
            </label>
            
            <label>
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-2);font-weight:600;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                  </svg>
                  Tanda Tangan Penerima <span style="color:#ef4444;">*</span>
                </div>
                <button type="button" class="btn ghost" id="clearSignature" style="padding:6px 12px;font-size:12px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                  </svg>
                  Hapus
                </button>
              </div>
              <div style="border:2px solid var(--border);border-radius:12px;overflow:hidden;background:var(--blue-light);">
                <canvas id="signatureCanvas" width="600" height="200" style="display:block;width:100%;height:auto;cursor:crosshair;touch-action:none;"></canvas>
              </div>
              <div style="font-size:11px;color:var(--text-2);margin-top:6px;font-style:italic;">
                ‚úçÔ∏è Tanda tangani di area kotak di atas
              </div>
            </label>
            
            <div class="actions" style="margin-top:20px;">
              <button class="btn primary" type="submit" id="submitStockOut">Keluarkan Semua Stok</button>
            </div>
          </form>
        </div>
      </section>

      <!-- History -->
      <section class="view hidden" id="history">
        <div style="margin-bottom:16px;">

          <!-- Export buttons: 2 kolom sejajar -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
            <button class="btn primary" id="exportPdfBtn" style="width:100%;padding:10px 8px;font-size:12px;justify-content:center;">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0;">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15L13,19H10Z"/>
              </svg>
              <span>Export Riwayat</span>
            </button>
            <button class="btn green" id="exportPerItemBtn" style="width:100%;padding:10px 8px;font-size:12px;justify-content:center;">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0;">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15L13,19H10Z"/>
              </svg>
              <span>Export Per Barang</span>
            </button>
          </div>
          <!-- Filter type: always 3 equal columns -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px;">
            <button class="btn ghost active" data-history-filter="all" type="button" style="width:100%;justify-content:center;font-size:12px;">Semua</button>
            <button class="btn ghost" data-history-filter="in" type="button" style="width:100%;justify-content:center;font-size:12px;">Stok Masuk</button>
            <button class="btn ghost" data-history-filter="out" type="button" style="width:100%;justify-content:center;font-size:12px;">Stok Keluar</button>
          </div>

          <!-- Category & Month filters: side by side -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <select id="historyCategoryFilter" style="padding:12px 10px;border-radius:10px;border:1.5px solid var(--border);width:100%;background:var(--surface);font-family:inherit;font-size:13px;color:var(--text);">
              <option value="">Semua Kategori</option>
            </select>
            <select id="historyMonthFilter" style="padding:12px 10px;border-radius:10px;border:1.5px solid var(--border);width:100%;background:var(--surface);font-family:inherit;font-size:13px;color:var(--text);">
              <option value="">Semua Bulan</option>
            </select>
          </div>
        </div>
        <div class="list" id="historyList"></div>
      </section>


      <!-- Manajemen Data -->
      <section class="view hidden" id="dataManagement">
        <div style="display:grid;gap:14px;">

          <!-- Info Card -->
          <div style="background:linear-gradient(135deg,var(--blue-light),#e0f2fe);border:1.5px solid var(--blue-mid);border-radius:var(--radius-lg);padding:16px;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
              <span style="font-size:20px;">üóÑÔ∏è</span>
              <span style="font-weight:700;font-size:15px;color:var(--blue-dark);">Manajemen Data</span>
            </div>
            <p style="font-size:13px;color:var(--text-2);line-height:1.6;margin:0;">Backup dan restore seluruh data inventori (barang & riwayat) dalam format file <strong>.json</strong>. Simpan backup secara berkala untuk mencegah kehilangan data.</p>
          </div>

          <!-- Backup -->
          <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-sm);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
              <div style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#ecfdf5,#d1fae5);border:1.5px solid #6ee7b7;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üì•</div>
              <div>
                <div style="font-weight:700;font-size:14px;color:var(--text);">Backup Data</div>
                <div style="font-size:12px;color:var(--text-3);">Unduh seluruh data sebagai file .json</div>
              </div>
            </div>
            <p style="font-size:12px;color:var(--text-2);line-height:1.5;margin:0 0 14px;">File backup berisi semua data barang dan riwayat transaksi. Simpan file ini di tempat yang aman.</p>
            <button class="btn green" id="backupDataBtn" style="width:100%;justify-content:center;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/></svg>
              Unduh Backup (.json)
            </button>
          </div>

          <!-- Restore -->
          <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-sm);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
              <div style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1.5px solid #93c5fd;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üì§</div>
              <div>
                <div style="font-weight:700;font-size:14px;color:var(--text);">Restore Data</div>
                <div style="font-size:12px;color:var(--text-3);">Pulihkan data dari file backup .json</div>
              </div>
            </div>
            <p style="font-size:12px;color:var(--text-2);line-height:1.5;margin:0 0 14px;">Pilih file backup yang sebelumnya diunduh. <strong>Data saat ini akan digantikan</strong> oleh data dari file backup.</p>
            <div style="background:var(--bg);border:2px dashed var(--border);border-radius:var(--radius);padding:20px;text-align:center;margin-bottom:14px;cursor:pointer;transition:border-color 0.2s,background 0.2s;" id="restoreDropZone"
              onclick="el('restoreFileInput').click()"
              ondragover="event.preventDefault();this.style.borderColor='var(--blue-1)';this.style.background='var(--blue-light)'"
              ondragleave="this.style.borderColor='var(--border)';this.style.background='var(--bg)'"
              ondrop="handleRestoreDrop(event)">
              <div style="font-size:28px;margin-bottom:8px;">üìÇ</div>
              <div style="font-size:13px;font-weight:600;color:var(--blue-dark);">Pilih File Backup</div>
              <div style="font-size:11px;color:var(--text-3);margin-top:4px;">Format: simery_backup_*.json</div>
              <div id="restoreFileName" style="font-size:12px;color:var(--success);font-weight:600;margin-top:8px;display:none;"></div>
            </div>
            <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="handleRestoreFile(this)"/>
            <button class="btn primary" id="restoreDataBtn" style="width:100%;justify-content:center;opacity:0.45;cursor:not-allowed;" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19,9H15V3H9V9H5L12,16L19,9M5,18V20H19V18H5Z"/></svg>
              Restore dari File Backup
            </button>
          </div>

          <!-- Divider -->
          <div style="height:1px;background:linear-gradient(90deg,transparent,#e2e8f0,transparent);border-radius:2px;"></div>

          <!-- Danger Zone -->
          <div style="background:var(--surface);border:1.5px solid rgba(244,63,94,0.3);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-sm);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
              <div style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#fff1f3,#ffe4e8);border:1.5px solid #fca5a5;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">‚ö†Ô∏è</div>
              <div>
                <div style="font-weight:700;font-size:14px;color:#b91c1c;">Hapus Seluruh Data Aplikasi</div>
                <div style="font-size:12px;color:var(--text-3);">Tindakan permanen yang tidak dapat dibatalkan</div>
              </div>
            </div>
            <p style="font-size:12px;color:var(--text-2);line-height:1.5;margin:0 0 14px;">Menghapus seluruh data barang dan riwayat secara permanen. Pastikan Anda sudah melakukan <strong>backup</strong> sebelum melanjutkan.</p>
            <button class="btn danger" id="deleteAllDataBtn" style="width:100%;justify-content:center;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
              Hapus Semua Data
            </button>
          </div>

        </div>
      </section>

<!-- ‚ïê‚ïê Reusable Confirm Modal (aksi non-destruktif) ‚ïê‚ïê -->
<div id="confirmModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(7,89,133,0.5);z-index:5000;padding:16px;backdrop-filter:blur(6px);">
  <div style="width:100%;max-width:400px;padding:24px 22px;border-radius:20px;background:#fff;box-shadow:0 20px 60px rgba(14,165,233,0.2);animation:slideUpModal 0.28s cubic-bezier(0.34,1.2,0.64,1) both;">
    <div style="text-align:center;margin-bottom:18px;">
      <div id="confirmModalIcon" style="width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 12px;"></div>
      <h3 id="confirmModalTitle" style="font-size:1.05rem;font-weight:800;color:var(--text);margin-bottom:6px;"></h3>
      <p id="confirmModalDesc" style="font-size:13px;color:var(--text-2);line-height:1.6;"></p>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn ghost" id="confirmModalCancel" style="flex:1;">Batal</button>
      <button class="btn primary" id="confirmModalOk" style="flex:1;"></button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê Delete Item Modal (destruktif, ketik HAPUS) ‚ïê‚ïê -->
<div id="deleteItemModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(7,89,133,0.55);z-index:5000;padding:16px;backdrop-filter:blur(6px);">
  <div style="width:100%;max-width:560px;padding:26px 22px;border-radius:20px;background:#fff;box-shadow:0 20px 60px rgba(244,63,94,0.2);animation:slideUpModal 0.28s cubic-bezier(0.34,1.2,0.64,1) both;">
    <div style="text-align:center;margin-bottom:18px;">
      <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#fff1f3,#ffe4e8);border:2px solid #fca5a5;display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 12px;">&#x1F5D1;&#xFE0F;</div>
      <h3 style="font-size:1.05rem;font-weight:800;color:#b91c1c;margin-bottom:6px;">Hapus Barang?</h3>
      <p id="deleteItemDesc" style="font-size:13px;color:var(--text-2);line-height:1.6;"></p>
    </div>
    <div style="background:#fff1f3;border:1.5px solid #fca5a5;border-radius:12px;padding:12px 14px;margin-bottom:18px;">
      <div style="font-size:12px;font-weight:700;color:#b91c1c;margin-bottom:7px;">Untuk melanjutkan, ketik <strong>HAPUS</strong> pada kolom di bawah:</div>
      <input id="deleteItemInput" type="text" placeholder="Ketik HAPUS untuk konfirmasi"
        style="width:100%;padding:10px 13px;border-radius:9px;border:2px solid #fca5a5;font-family:inherit;font-size:14px;font-weight:700;letter-spacing:0.05em;color:#b91c1c;background:#fff;transition:border-color 0.2s,box-shadow 0.2s;outline:none;"/>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn ghost" id="deleteItemCancelBtn" style="flex:1;">Batal</button>
      <button class="btn danger" id="deleteItemConfirmBtn" style="flex:1;opacity:0.45;cursor:not-allowed;" disabled>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        Ya, Hapus Barang
      </button>
    </div>
  </div>
</div>

<!-- Delete All Data Modal -->
<div id="deleteAllModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(7,89,133,0.55);z-index:4000;padding:16px;backdrop-filter:blur(6px);">
  <div style="width:100%;max-width:560px;padding:28px 24px;border-radius:20px;background:#fff;box-shadow:0 20px 60px rgba(244,63,94,0.2);animation:slideUpModal 0.3s cubic-bezier(0.34,1.2,0.64,1) both;">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#fff1f3,#ffe4e8);border:2px solid #fca5a5;display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 14px;">üóëÔ∏è</div>
      <h3 style="font-size:1.15rem;font-weight:800;color:#b91c1c;margin-bottom:8px;">Hapus Semua Data?</h3>
      <p style="font-size:13px;color:var(--text-2);line-height:1.6;">Tindakan ini akan <strong>menghapus seluruh data barang dan riwayat aplikasi secara permanen</strong>. Data yang sudah dihapus tidak dapat dikembalikan.</p>
    </div>
    <div style="background:#fff1f3;border:1.5px solid #fca5a5;border-radius:12px;padding:14px 16px;margin-bottom:20px;">
      <div style="font-size:12px;font-weight:700;color:#b91c1c;margin-bottom:8px;">‚ö†Ô∏è Untuk melanjutkan, ketik <strong>HAPUS</strong> pada kolom di bawah:</div>
      <input id="deleteConfirmInput" type="text" placeholder='Ketik "HAPUS" untuk konfirmasi'
        style="width:100%;padding:11px 14px;border-radius:9px;border:2px solid #fca5a5;font-family:inherit;font-size:14px;font-weight:700;letter-spacing:0.05em;color:#b91c1c;background:#fff;transition:border-color 0.2s,box-shadow 0.2s;outline:none;"/>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn ghost" id="cancelDeleteBtn" style="flex:1;">Batal</button>
      <button class="btn danger" id="confirmDeleteBtn" style="flex:1;opacity:0.45;cursor:not-allowed;" disabled>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
        </svg>
        Hapus Semua Data
      </button>
    </div>
  </div>
</div>

<!-- Edit Item Modal -->
      <div id="editModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(7,89,133,0.5);z-index:3000;padding:16px;backdrop-filter:blur(4px);">
        <div style="width:100%;max-width:400px;max-height:90vh;padding:20px;border-radius:20px;background:#fff;overflow:hidden;box-shadow:0 16px 48px rgba(14,165,233,0.2);">
          <h3 style="margin:0 0 16px 0;text-align:center;font-size:1.1rem;color:var(--blue-dark);">Edit Barang</h3>
          
          <form id="editForm" class="form">
            <label>Nama Barang
              <input id="editName" placeholder="Nama barang" required />
            </label>
            <label>Kategori
              <select id="editCategory" required>
                <option value="">Pilih Kategori</option>
                <option value="Alat Kebersihan">Alat Kebersihan</option>
                <option value="Bahan Kebersihan">Bahan Kebersihan</option>
                <option value="Alat Tulis Kantor">Alat Tulis Kantor</option>
                <option value="Alat Kelistrikan">Alat Kelistrikan</option>
                <option value="Alat Olahraga">Alat Olahraga</option>
                <option value="Alat Kesehatan">Alat Kesehatan</option>
              </select>
            </label>
            <label>Stok
              <input id="editStock" type="number" min="0" required />
            </label>
            <label>Barcode (Opsional)
              <div class="barcode-input-group">
                <input id="editBarcode" placeholder="Scan atau ketik barcode" />
                <button type="button" class="btn-barcode" id="editScanBarcodeBtn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h1v12H7V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6z"/>
                  </svg>
                  <span class="btn-barcode-text"><span>Scan</span><span>Barcode</span></span>
                </button>
              </div>
            </label>
            
            <div class="modal-actions">
              <button type="button" class="btn ghost" id="cancelEdit">Batal</button>
              <button type="submit" class="btn primary">Simpan</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Add Stock Modal -->
      <div id="addStockModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(7,89,133,0.5);z-index:3000;padding:16px;backdrop-filter:blur(4px);">
        <div style="width:100%;max-width:400px;max-height:90vh;padding:20px;border-radius:20px;background:#fff;overflow:hidden;box-shadow:0 16px 48px rgba(14,165,233,0.2);">
          <h3 style="margin:0 0 16px 0;text-align:center;font-size:1.1rem;color:var(--blue-dark);display:flex;align-items:center;justify-content:center;gap:8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
            </svg>
            Tambah Stok
          </h3>
          
          <form id="addStockForm" class="form">
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C13.1 2 14 2.9 14 4V6H20C20.6 6 21 6.4 21 7S20.6 8 20 8H14V10C14 11.1 13.1 12 12 12S10 11.1 10 10V8H4C3.4 8 3 7.6 3 7S3.4 6 4 6H10V4C10 2.9 10.9 2 12 2M12 14C13.1 14 14 14.9 14 16V18H20C20.6 18 21 18.4 21 19S20.6 20 20 20H14V22C14 23.1 13.1 24 12 24S10 23.1 10 22V20H4C3.4 20 3 19.6 3 19S3.4 18 4 18H10V16C10 14.9 10.9 14 12 14Z"/>
                </svg>
                Nama Barang
              </div>
              <input id="addStockName" placeholder="Nama barang" readonly style="background:#f0f0f0;color:#666;" />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2M6.5 12.5L7.5 16.5L11.5 17.5L7.5 18.5L6.5 22.5L5.5 18.5L1.5 17.5L5.5 16.5L6.5 12.5M17.5 12.5L18.5 16.5L22.5 17.5L18.5 18.5L17.5 22.5L16.5 18.5L12.5 17.5L16.5 16.5L17.5 12.5"/>
                </svg>
                Kategori
              </div>
              <input id="addStockCategory" placeholder="Kategori barang" readonly style="background:#f0f0f0;color:#666;" />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 4V2C7 1.45 7.45 1 8 1S9 1.45 9 2V4H15V2C15 1.45 15.45 1 16 1S17 1.45 17 2V4H20C21.11 4 22 4.89 22 6V20C22 21.11 21.11 22 20 22H4C2.89 22 2 21.11 2 20V6C2 4.89 2.89 4 4 4H7M4 8V20H20V8H4M6 10H8V12H6V10M10 10H12V12H10V10M14 10H16V12H14V10M6 14H8V16H6V14M10 14H12V16H10V14M14 14H16V16H14V14"/>
                </svg>
                Stok Saat Ini
              </div>
              <input id="addStockCurrent" type="number" placeholder="Stok saat ini" readonly style="background:#f0f0f0;color:#666;" />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                </svg>
                Tambah Stok
              </div>
              <input id="addStockQuantity" type="number" min="1" placeholder="Masukkan jumlah stok yang ditambah" required />
            </label>
            
            <label>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;color:var(--text-2);font-weight:600;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M14,10H12V8H14M14,16H12V12H14M20,8H17.19C16.74,7.22 16.12,6.55 15.37,6.04L17,4.41L15.59,3L13.42,5.17C12.96,5.06 12.5,5 12,5C11.5,5 11.04,5.06 10.59,5.17L8.41,3L7,4.41L8.62,6.04C7.88,6.55 7.26,7.22 6.81,8H4V10H6.09C6.04,10.33 6,10.66 6,11V12H4V14H6V15C6,15.34 6.04,15.67 6.09,16H4V18H6.81C7.85,19.79 9.78,21 12,21C14.22,21 16.15,19.79 17.19,18H20V16H17.91C17.96,15.67 18,15.34 18,15V14H20V12H18V11C18,10.66 17.96,10.33 17.91,10H20V8Z"/>
                </svg>
                Keterangan (Opsional)
              </div>
              <textarea id="addStockNotes" placeholder="Alasan penambahan stok, supplier, dll."></textarea>
            </label>
            
            <div class="modal-actions">
              <button type="button" class="btn ghost" id="cancelAddStock">Batal</button>
              <button type="submit" class="btn primary">Tambah Stok</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Enhanced Scanner Modal -->
      <div id="scannerModal">
        <div class="modal-card">
          <!-- drag handle rendered by ::before -->
          <div class="scanner-header">
            <div class="scanner-title">
              <div class="scanner-title-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                  <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h1v12H7V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6z"/>
                </svg>
              </div>
              Scan Barcode
            </div>
            <button class="scanner-close-btn" id="closeScanner" aria-label="Tutup">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>

          <div class="scanner-hint">Arahkan kamera ke barcode produk</div>

          <div class="scanner-viewport">
            <div id="reader"></div>
            <!-- custom overlay: scan line + corner brackets -->
            <div class="scan-frame-overlay">
              <div class="scan-line"></div>
              <div class="scan-corners">
                <span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>

          <div class="scanner-status">
            <div class="scanner-status-dot"></div>
            <div class="scanner-status-text">Menunggu barcode‚Ä¶</div>
          </div>
        </div>
      </div>
    </main>
    <footer style="text-align:center;padding:14px 16px;font-size:11px;color:var(--text-3);border-top:1px solid var(--border-2);background:var(--surface);">
      Dikembangkan Oleh <strong style="color:var(--text-2);">Twin Insani, S.Kom</strong>
    </footer>
  </div>

<script>
// IndexedDB Configuration
const DB_NAME    = 'SimeryDB';
const DB_VERSION = 2;                 // bumped: added appState store
const SIGNATURE_STORE = 'signatures';
const STATE_STORE     = 'appState';
let _db = null;

// Initialize IndexedDB
function initIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onerror = () => {
      console.error('IndexedDB error:', request.error);
      reject(request.error);
    };

    request.onsuccess = () => {
      _db = request.result;
      console.log('IndexedDB initialized (v' + DB_VERSION + ')');
      resolve(_db);
    };

    request.onupgradeneeded = (event) => {
      const db = event.target.result;

      // signatures store (existed in v1)
      if (!db.objectStoreNames.contains(SIGNATURE_STORE)) {
        const sigStore = db.createObjectStore(SIGNATURE_STORE, { keyPath: 'historyId' });
        sigStore.createIndex('historyId', 'historyId', { unique: true });
      }

      // appState store (new in v2)
      if (!db.objectStoreNames.contains(STATE_STORE)) {
        db.createObjectStore(STATE_STORE, { keyPath: 'key' });
        console.log('appState object store created');
      }
    };
  });
}

// Save signature to IndexedDB ‚Äî [FIX-C] simpan sebagai Blob bukan Base64 string
// Blob ~33% lebih kecil (tidak ada Base64 encoding overhead)
function saveSignatureToIndexedDB(historyId, signatureData) {
  return new Promise((resolve, reject) => {
    if (!_db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = _db.transaction([SIGNATURE_STORE], 'readwrite');
    const objectStore = transaction.objectStore(SIGNATURE_STORE);

    // Konversi Base64 data URL ke Blob untuk penyimpanan yang lebih efisien
    let storeValue = signatureData;
    let mimeType = 'image/jpeg';
    try {
      const arr = signatureData.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      storeValue = new Blob([u8arr], { type: mime });
      mimeType = mime;
    } catch(e) {
      // Fallback: tetap simpan sebagai string jika konversi gagal
      console.warn('Signature Blob conversion failed, storing as string:', e);
    }
    
    const data = {
      historyId: historyId,
      signature: storeValue,
      mimeType: mimeType,
      timestamp: new Date().toISOString()
    };
    
    const request = objectStore.put(data);
    
    request.onsuccess = () => {
      console.log('Signature saved to IndexedDB:', historyId);
      resolve(true);
    };
    
    request.onerror = () => {
      console.error('Error saving signature:', request.error);
      reject(request.error);
    };
  });
}

// Get signature from IndexedDB ‚Äî [FIX-C] konversi Blob kembali ke data URL untuk jsPDF
// Backward-compatible: signature lama yang tersimpan sebagai string tetap bekerja
function getSignatureFromIndexedDB(historyId) {
  return new Promise((resolve, reject) => {
    if (!_db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = _db.transaction([SIGNATURE_STORE], 'readonly');
    const objectStore = transaction.objectStore(SIGNATURE_STORE);
    const request = objectStore.get(historyId);
    
    request.onsuccess = () => {
      if (!request.result) { resolve(null); return; }
      
      const stored = request.result.signature;

      // Jika tersimpan sebagai string (legacy Base64), kembalikan langsung
      if (typeof stored === 'string') {
        resolve(stored);
        return;
      }

      // Jika tersimpan sebagai Blob (baru), konversi ke data URL untuk jsPDF
      if (stored instanceof Blob) {
        const reader = new FileReader();
        reader.onload  = () => resolve(reader.result);
        reader.onerror = () => {
          console.error('Error reading signature Blob');
          resolve(null);
        };
        reader.readAsDataURL(stored);
        return;
      }

      resolve(null);
    };
    
    request.onerror = () => {
      console.error('Error getting signature:', request.error);
      reject(request.error);
    };
  });
}

// Get all signatures from IndexedDB
function getAllSignaturesFromIndexedDB() {
  return new Promise((resolve, reject) => {
    if (!_db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = _db.transaction([SIGNATURE_STORE], 'readonly');
    const objectStore = transaction.objectStore(SIGNATURE_STORE);
    const request = objectStore.getAll();
    
    request.onsuccess = () => {
      const signatures = {};
      request.result.forEach(item => {
        signatures[item.historyId] = item.signature;
      });
      resolve(signatures);
    };
    
    request.onerror = () => {
      console.error('Error getting all signatures:', request.error);
      reject(request.error);
    };
  });
}

// Delete signature from IndexedDB
function deleteSignatureFromIndexedDB(historyId) {
  return new Promise((resolve, reject) => {
    if (!_db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = _db.transaction([SIGNATURE_STORE], 'readwrite');
    const objectStore = transaction.objectStore(SIGNATURE_STORE);
    const request = objectStore.delete(historyId);
    
    request.onsuccess = () => {
      console.log('Signature deleted from IndexedDB:', historyId);
      resolve(true);
    };
    
    request.onerror = () => {
      console.error('Error deleting signature:', request.error);
      reject(request.error);
    };
  });
}

// App State and Variables
const STORAGE_KEY = 'simery_inventory_v2'; // kept for legacy migration only
const el = id => document.getElementById(id);
const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
const escapeHtml = s => (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
const fmtDate = s => new Date(s).toLocaleString('id-ID');

let state = { items: [], history: [] };
let _selectedItems = [];
let _currentHistoryFilter = 'all';
let _currentHistoryCategoryFilter = '';
let _currentHistoryMonthFilter = '';
let _currentManageFilter = 'all';
let _scanner = null;
let _currentEditItem = null;
let _currentAddStockItem = null;
let _signatureCanvas = null;
let _signatureCtx = null;
let _isDrawing = false;
let _signatureData = null;

// [FIX #3] Item lookup Map ‚Äî O(1) sebagai ganti find() O(n) di setiap filter/render
let _itemMap = new Map();
function buildItemMap() {
  _itemMap = new Map(state.items.map(i => [i.id, i]));
}

// ‚îÄ‚îÄ IDB helpers: read/write appState ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function idbGetState() {
  return new Promise((resolve) => {
    if (!_db) return resolve(null);
    const tx  = _db.transaction([STATE_STORE], 'readonly');
    const req = tx.objectStore(STATE_STORE).get('main');
    req.onsuccess = () => resolve(req.result ? req.result.data : null);
    req.onerror   = () => resolve(null);
  });
}

function idbPutState(data) {
  return new Promise((resolve) => {
    if (!_db) return resolve(false);
    const tx = _db.transaction([STATE_STORE], 'readwrite');
    tx.objectStore(STATE_STORE).put({ key: 'main', data });
    tx.oncomplete = () => resolve(true);
    tx.onerror    = () => resolve(false);
    tx.onabort    = () => resolve(false);
  });
}

// ‚îÄ‚îÄ Load: IDB-first, fallback + migrate from localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function load() {
  try {
    let saved = await idbGetState();

    // Migrate from localStorage if IDB is empty
    if (!saved) {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        saved = JSON.parse(raw);
        await idbPutState(saved);
        localStorage.removeItem(STORAGE_KEY);   // clean up old storage
        console.log('Migrated state from localStorage ‚Üí IndexedDB');
      }
    }

    if (saved) {
      state = saved;
      state.items   = state.items   || [];
    } else {
      // Fresh install: seed demo data
      state.items = [
        { id: 'itm-1', name: 'Pulpen',        category: 'Alat Tulis Kantor', stock: 25, barcode: '1234567890' },
        { id: 'itm-2', name: 'Sapu Lantai',   category: 'Alat Kebersihan',   stock: 4,  barcode: '2345678901' },
        { id: 'itm-3', name: 'Sabun Lantai',  category: 'Bahan Kebersihan',  stock: 10, barcode: '3456789012' },
        { id: 'itm-4', name: 'Lampu LED 10W', category: 'Alat Kelistrikan',  stock: 0,  barcode: '4567890123' }
      ];
      await save();
    }
    buildItemMap(); // [FIX #3] Build O(1) lookup map setelah state dimuat
  } catch(e) {
    console.error('load error', e);
    state = { items: [], history: [] };
  }
}

// ‚îÄ‚îÄ Save: write to IDB (fire-and-forget from sync callers) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HISTORY_MAX = 1000; // [FIX-B] Batas entri history aktif ‚Äî cegah bloat data

async function save() {
  try {
    state.lastModified = Date.now();
    buildItemMap(); // [FIX #3] Rebuild lookup map setiap kali data berubah

    // [FIX-B] Trim history jika melebihi batas ‚Äî pertahankan entri TERBARU
    if (state.history && state.history.length > HISTORY_MAX) {
      // Sort by date descending, ambil 1000 terbaru
      state.history = state.history
        .slice()
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, HISTORY_MAX);
      console.log('[SiMERY] History di-trim ke', HISTORY_MAX, 'entri terbaru');
    }

    await idbPutState(state);
    if (typeof debouncedSyncToDrive === 'function') debouncedSyncToDrive(state);
  } catch(e) { console.error('save error', e); }
}


function renderCounts(){
  el('totalN').textContent = state.items.length;
  el('stockN').textContent = state.items.reduce((a,b)=>a+(+b.stock||0),0);
  el('lowN').textContent = state.items.filter(i => (+i.stock) > 0 && (+i.stock) <= 5).length;
}

function stockPriority(item){
  if(item.stock <= 0) return 0;       // kosong ‚Üí paling atas
  if(item.stock <= 5) return 1;       // hampir habis ‚Üí kedua
  return 2;                           // tersedia ‚Üí bawah
}

function stockBadge(stock){
  if(stock <= 0)  return { cls:'empty', text:'Kosong',        icon:'‚úï' };
  if(stock <= 5)  return { cls:'low',   text:'Hampir Habis',  icon:'‚ö†' };
  return              { cls:'available', text:'Tersedia',     icon:'‚úì' };
}

function renderItems(query=''){
  const container = el('items');
  const q = (query||'').toString().trim().toLowerCase();

  let filtered = state.items.filter(item => {
    if(!q) return true;
    return (item.name||'').toLowerCase().includes(q) ||
           (item.category||'').toLowerCase().includes(q) ||
           (item.barcode||'').toLowerCase().includes(q);
  });

  if(filtered.length === 0){
    container.innerHTML = '<div style="padding:12px;color:var(--text-2)">Tidak ada barang.</div>';
    return;
  }

  // Urutan: kosong ‚Üí hampir habis ‚Üí tersedia, lalu alphabetical
  filtered.sort((a, b) => stockPriority(a) - stockPriority(b) || (a.name||'').localeCompare(b.name||''));

  // [FIX #4] Gunakan DocumentFragment untuk batch insert (satu kali reflow)
  const frag = document.createDocumentFragment();

  filtered.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const { cls, text, icon } = stockBadge(item.stock);

    card.innerHTML = `
      <div class="top">
        <h3>${escapeHtml(item.name)}</h3>
        <div class="badge ${cls}">${icon} ${text}</div>
      </div>
      <div class="meta">${escapeHtml(item.category || '-')} | Stok: <strong>${item.stock}</strong>${item.barcode ? '<br/>üè∑Ô∏è ' + escapeHtml(item.barcode) : ''}</div>
    `;

    const actions = document.createElement('div');
    actions.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;';

    const outBtn = document.createElement('button');
    outBtn.className = 'btn orange';
    outBtn.style.cssText = 'width:100%;justify-content:center;';
    outBtn.textContent = 'Keluarkan';
    outBtn.setAttribute('aria-label', `Keluarkan ${item.name}`);
    outBtn.onclick = () => {
      switchTab('stockOut');
      setTimeout(() => {
        const searchInput = el('stockOutSearch');
        if(searchInput) {
          searchInput.value = item.name;
          searchInput.dataset.selectedId = item.id;
        }
        const qty = el('stockOutQty');
        if(qty) qty.focus();
      }, 80);
    };

    const editBtn = document.createElement('button');
    editBtn.className = 'btn green';
    editBtn.style.cssText = 'width:100%;justify-content:center;';
    editBtn.setAttribute('aria-label', `Tambah stok ${item.name}`);
    editBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
      </svg>
      Tambah Stok
    `;
    editBtn.onclick = ()=> addStock(item.id);

    actions.appendChild(outBtn);
    actions.appendChild(editBtn);
    card.appendChild(actions);
    frag.appendChild(card);
  });

  // Satu kali reflow ‚Äî kosongkan dan isi sekaligus
  container.innerHTML = '';
  container.appendChild(frag);
}
let _currentManageCategoryFilter = '';

function updateManageBadge(){
  const badge = el('manageListBadge');
  if(badge) badge.textContent = state.items.length + ' barang';
}

function renderManageCategoryDropdown(){
  const sel = el('manageCategoryDropdown');
  if(!sel) return;
  const prev = sel.value;
  const categories = [...new Set(state.items.map(i => i.category).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">Semua Kategori</option>';
  categories.forEach(cat => {
    const o = document.createElement('option');
    o.value = cat; o.textContent = cat;
    sel.appendChild(o);
  });
  // Restore pilihan sebelumnya jika masih ada
  if(categories.includes(prev)) sel.value = prev;
  else { sel.value = ''; _currentManageCategoryFilter = ''; }
}

function renderManageList(query = '', filter = 'all'){
  const container = el('manageList');
  updateManageBadge();
  if(state.items.length === 0){ 
    container.innerHTML = '<div style="padding:12px;color:var(--text-2)">Belum ada barang.</div>'; 
    return; 
  }

  const q = (query||'').toString().trim().toLowerCase();
  
  let filtered = state.items.filter(item => {
    const matchesSearch = !q || 
      (item.name||'').toLowerCase().includes(q) ||
      (item.category||'').toLowerCase().includes(q) ||
      (item.barcode||'').toLowerCase().includes(q);
    
    let matchesFilter = true;
    if (filter === 'available') {
      matchesFilter = item.stock > 5;
    } else if (filter === 'low') {
      matchesFilter = item.stock > 0 && item.stock <= 5;
    } else if (filter === 'empty') {
      matchesFilter = item.stock <= 0;
    }

    const matchesCategory = !_currentManageCategoryFilter || item.category === _currentManageCategoryFilter;
    
    return matchesSearch && matchesFilter && matchesCategory;
  });

  if(filtered.length === 0){
    container.innerHTML = '<div style="padding:12px;color:var(--text-2)">Tidak ada barang yang sesuai.</div>';
    return;
  }

  // Urutan: kosong ‚Üí hampir habis ‚Üí tersedia, lalu alphabetical
  filtered.sort((a, b) => stockPriority(a) - stockPriority(b) || (a.name||'').localeCompare(b.name||''));

  // [FIX #4] DocumentFragment untuk batch insert
  const frag = document.createDocumentFragment();

  filtered.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const { cls, text, icon } = stockBadge(item.stock);
    card.innerHTML = `
      <div class="top">
        <h3>${escapeHtml(item.name)}</h3>
        <div class="badge ${cls}">${icon} ${item.stock} ‚Äî ${text}</div>
      </div>
      <div class="meta">Kategori: ${escapeHtml(item.category || '-')} ${item.barcode ? '<br/>üè∑Ô∏è ' + escapeHtml(item.barcode) : ''}</div>
    `;
    const actions = document.createElement('div');
    actions.className = 'actions';

    const edit = document.createElement('button');
    edit.className = 'btn ghost';
    edit.textContent = 'Edit';
    edit.setAttribute('aria-label', `Edit ${item.name}`);
    edit.onclick = () => editItem(item.id);

    const del = document.createElement('button');
    del.className = 'btn';
    del.textContent = 'Hapus';
    del.setAttribute('aria-label', `Hapus ${item.name}`);
    del.onclick = () => {
      showDeleteItemModal({
        itemName: item.name,
        itemCategory: item.category,
        itemStock: item.stock,
        onConfirm: () => {
          state.history.push({
            id: uid(),
            itemId: item.id,
            itemName: item.name,
            type: 'delete',
            qty: item.stock,
            date: new Date().toISOString(),
            recipient: 'System',
            note: 'Barang dihapus dari inventory. Kategori: ' + (item.category||'-') + '. Stok terakhir: ' + item.stock
          });
          state.items = state.items.filter(x => x.id !== item.id);
          save(); renderAll();
          showNotification('error', 'Barang dihapus', item.name + ' telah dihapus dari inventory');
        }
      });
    };

    actions.appendChild(edit);
    actions.appendChild(del);
    card.appendChild(actions);
    frag.appendChild(card);
  });

  // Satu kali reflow
  container.innerHTML = '';
  container.appendChild(frag);
}

function renderSelects() {
  const categoryFilter = el('historyCategoryFilter');
  if (categoryFilter) {
    const prev = categoryFilter.value;
    const categories = [...new Set(state.items.map(item => item.category).filter(c => c))];
    categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
    categories.forEach(cat => {
      const o = document.createElement('option');
      o.value = cat; o.textContent = cat;
      categoryFilter.appendChild(o);
    });
    categoryFilter.value = prev;
  }

  const monthFilter = el('historyMonthFilter');
  if (monthFilter && state.history) {
    const prev = monthFilter.value;
    const monthSet = new Set();
    state.history.forEach(h => {
      if (!h.date) return;
      const d = new Date(h.date);
      monthSet.add(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'));
    });
    const months = [...monthSet].sort().reverse();
    const BULAN = ['','Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
    monthFilter.innerHTML = '<option value="">Semua Bulan</option>';
    months.forEach(m => {
      const [yr, mo] = m.split('-');
      const o = document.createElement('option');
      o.value = m;
      o.textContent = BULAN[parseInt(mo)] + ' ' + yr;
      monthFilter.appendChild(o);
    });
    monthFilter.value = prev;
  }
}

function groupHistoryByTransaction(historyArr) {
  const transactions = {};
  
  historyArr.forEach(h => {
    // [FIX #3] O(1) lookup via _itemMap sebagai ganti find() O(n)
    const item = _itemMap.get(h.itemId);
    
    // Gunakan transactionId jika ada, fallback ke grouping by recipient+time
    let txKey;
    if (h.transactionId) {
      txKey = h.transactionId;
    } else if (h.type === 'out') {
      // Legacy: group by recipient + time within 5 seconds
      let foundKey = null;
      for (const k in transactions) {
        const tx = transactions[k];
        const timeDiff = Math.abs(new Date(h.date) - new Date(tx.date));
        if (tx.recipient === (h.recipient || '') && tx.type === h.type && tx.note === (h.note || '') && timeDiff < 5000) {
          foundKey = k;
          break;
        }
      }
      txKey = foundKey || ('tx_' + h.id);
    } else {
      txKey = 'tx_' + h.id; // stok masuk tetap per-item
    }
    
    if (!transactions[txKey]) {
      transactions[txKey] = {
        txKey,
        type: h.type,
        date: h.date,
        recipient: h.recipient || '-',
        note: h.note || '',
        items: [],
      };
    }
    transactions[txKey].items.push({
      historyId: h.id,
      itemName: item?.name || h.itemName || '[dihapus]',
      category: item?.category || '-',
      qty: h.qty,
      note: h.note || '',
    });
  });
  
  return Object.values(transactions).sort((a, b) => new Date(b.date) - new Date(a.date));
}

function renderHistory(){
  const c = el('historyList');
  c.innerHTML = '';
  if(!state.history || state.history.length === 0){ 
    c.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-3)">Belum ada riwayat transaksi.</div>'; 
    return; 
  }
  
  let filtered = state.history.slice();
  
  if (_currentHistoryFilter !== 'all') {
    filtered = filtered.filter(h => h.type === _currentHistoryFilter);
  }
  
  if (_currentHistoryCategoryFilter) {
    filtered = filtered.filter(h => {
      // [FIX #3] O(1) lookup via _itemMap
      const item = _itemMap.get(h.itemId);
      return item && item.category === _currentHistoryCategoryFilter;
    });
  }

  if (_currentHistoryMonthFilter) {
    filtered = filtered.filter(h => {
      if (!h.date) return false;
      const d = new Date(h.date);
      return (d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0')) === _currentHistoryMonthFilter;
    });
  }
  
  if (filtered.length === 0) {
    c.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-3)">Tidak ada riwayat yang sesuai.</div>';
    return;
  }
  
  const transactions = groupHistoryByTransaction(filtered);
  
  transactions.forEach(tx => {
    const isOut = tx.type === 'out';
    const isAdd = tx.type === 'add';
    const isEdit = tx.type === 'edit';
    const isDelete = tx.type === 'delete';
    const dateStr = fmtDate(tx.date);
    const totalQty = tx.items.reduce((s, i) => s + i.qty, 0);
    
    const card = document.createElement('div');
    card.className = 'card tx-card';
    card.style.cssText = 'gap:0;padding:0;overflow:hidden;';
    
    // Header bar
    let headerBg, badgeColor, badgeLabel, accentColor, borderColor;
    if (isOut) {
      headerBg = 'linear-gradient(135deg,#fff1f3,#fff5f7)';
      badgeColor = 'empty'; badgeLabel = '‚Üë Stok Keluar';
      accentColor = 'var(--danger)'; borderColor = 'rgba(244,63,94,0.18)';
    } else if (isAdd) {
      headerBg = 'linear-gradient(135deg,#ecfdf5,#f0fff8)';
      badgeColor = 'available'; badgeLabel = '‚úö Barang Ditambahkan';
      accentColor = 'var(--success)'; borderColor = 'rgba(16,185,129,0.18)';
    } else if (isEdit) {
      headerBg = 'linear-gradient(135deg,#fffbeb,#fefce8)';
      badgeColor = 'low'; badgeLabel = '‚úé Barang Diedit';
      accentColor = 'var(--warning)'; borderColor = 'rgba(245,158,11,0.18)';
    } else if (isDelete) {
      headerBg = 'linear-gradient(135deg,#fff1f3,#fff5f7)';
      badgeColor = 'empty'; badgeLabel = '‚úï Barang Dihapus';
      accentColor = 'var(--danger)'; borderColor = 'rgba(244,63,94,0.25)';
    } else {
      headerBg = 'linear-gradient(135deg,#ecfdf5,#f0fff8)';
      badgeColor = 'available'; badgeLabel = '‚Üì Stok Masuk';
      accentColor = 'var(--success)'; borderColor = 'rgba(16,185,129,0.18)';
    }
    
    // Build items preview (first 2 then "...+N lagi")
    const previewItems = tx.items.slice(0, 2);
    const extra = tx.items.length - 2;
    let itemsHtml = previewItems.map(it =>
      `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(14,165,233,0.07);border:1px solid rgba(14,165,233,0.15);border-radius:6px;padding:2px 8px;font-size:11px;color:var(--text-2);">
        ${escapeHtml(it.itemName)} <strong style="color:var(--text)">${it.qty}</strong>
      </span>`
    ).join('');
    if (extra > 0) {
      itemsHtml += `<span style="font-size:11px;color:var(--text-3);padding:2px 4px;">+${extra} lainnya</span>`;
    }
    
    const printBtnHtml = isOut ? `
      <button onclick="printTransactionPDF('${tx.txKey}')" style="
        display:inline-flex;align-items:center;gap:5px;
        padding:7px 13px;border-radius:8px;border:1.5px solid rgba(14,165,233,0.3);
        background:var(--blue-light);color:var(--blue-dark);
        font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;
        transition:background 0.15s;white-space:nowrap;flex-shrink:0;
      " onmouseover="this.style.background='var(--blue-mid)'" onmouseout="this.style.background='var(--blue-light)'">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M18 17H6v-2h12v2zm0-4H6v-2h12v2zm0-4H6V7h12v2zM3 22l1.5-1.5L6 22l1.5-1.5L9 22l1.5-1.5L12 22l1.5-1.5L15 22l1.5-1.5L18 22l1.5-1.5L21 22V2l-1.5 1.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2 4.5 3.5 3 2v20z"/></svg>
        Cetak PDF
      </button>` : '';

    // For add/edit/delete: show item name prominently; for out/in: show recipient
    const primaryLabel = (isAdd || isEdit || isDelete)
      ? escapeHtml(tx.items[0]?.itemName || '-')
      : escapeHtml(tx.recipient);
    // Note to show under badge
    const noteText = (isAdd || isEdit || isDelete)
      ? (tx.items[0]?.note || tx.note || '')
      : tx.note;
    // Subtitle line
    const subtitleLine = (isAdd || isDelete)
      ? `üïê ${dateStr} &nbsp;¬∑&nbsp; üì¶ Stok: ${totalQty}`
      : isEdit
        ? `üïê ${dateStr}`
        : `üïê ${dateStr} &nbsp;¬∑&nbsp; üì¶ ${tx.items.length} jenis ¬∑ ${totalQty} unit`;
    
    card.innerHTML = `
      <div style="padding:13px 14px 11px;background:${headerBg};border-bottom:1px solid ${borderColor};">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;">
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:4px;">
              <span class="badge ${badgeColor}" style="border:1px solid ${borderColor};">${badgeLabel}</span>
              <span style="font-size:12px;font-weight:700;color:var(--text);">${primaryLabel}</span>
            </div>
            <div style="font-size:11px;color:var(--text-3);">
              ${subtitleLine}
            </div>
            ${noteText ? `<div style="font-size:11px;color:var(--text-2);margin-top:5px;line-height:1.5;background:rgba(0,0,0,0.03);border-radius:6px;padding:5px 8px;">üìù ${escapeHtml(noteText)}</div>` : ''}
          </div>
          ${printBtnHtml}
        </div>
        ${(!isEdit && !isAdd && !isDelete) ? `<div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;">${itemsHtml}</div>` : ''}
      </div>
      ${tx.items.length > 2 ? `
        <div style="padding:10px 14px;">
          <div style="font-size:12px;font-weight:600;color:var(--text-2);margin-bottom:7px;">Semua Barang (${tx.items.length} item):</div>
          <div style="display:grid;gap:5px;">
            ${tx.items.map((it, idx) => `
              <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg);border-radius:8px;border:1px solid var(--border);">
                <div>
                  <span style="font-size:13px;font-weight:600;color:var(--text);">${idx+1}. ${escapeHtml(it.itemName)}</span>
                  <span style="font-size:11px;color:var(--text-3);margin-left:6px;">${escapeHtml(it.category)}</span>
                </div>
                <span style="font-size:13px;font-weight:700;color:${accentColor};">${it.qty} unit</span>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    `;
    
    c.appendChild(card);
  });
}

function getActiveTab() {
  const t = document.querySelector('.tab.active');
  return t ? t.dataset.tab : 'dashboard';
}

function renderAll(){
  renderCounts();
  renderSelects();
  updateManageBadge();
  renderManageCategoryDropdown();
  const tab = getActiveTab();
  if (tab === 'dashboard')       renderItems(el('q')?.value || '');
  else if (tab === 'manage')     { if(_manageListOpen) renderManageList(el('manageSearch')?.value || '', _currentManageFilter); }
  else if (tab === 'history')    renderHistory();
  // stockOut & dataManagement have no dynamic list renders
}

let _suppressSyncNotif = false; // [GUARD] suppress notif saat proses ganti user
let _manageListOpen = false;
let _manageListHeight = 0; // cache tinggi terakhir saat open, hindari reflow saat collapse

function toggleManageList(){
  _manageListOpen = !_manageListOpen;
  const body    = el('manageListBody');
  const chevron = el('manageListChevron');
  const toggle  = el('manageListToggle');

  if(_manageListOpen){
    // ‚îÄ‚îÄ Expand ‚îÄ‚îÄ
    // 1. Render konten dulu (DOM diisi, tapi belum di-layout oleh browser)
    renderManageCategoryDropdown();
    renderManageList(el('manageSearch')?.value || '', _currentManageFilter);

    // 2. Buka visibility sementara agar browser bisa hitung tinggi, tapi tetap invisible
    body.style.maxHeight = 'none';
    body.style.visibility = 'hidden';

    // 3. Tunggu satu frame ‚Äî browser layout konten, baru ukur scrollHeight
    requestAnimationFrame(() => {
      _manageListHeight = body.scrollHeight;
      // 4. Kembalikan ke 0 dan tampilkan, lalu animasikan ke tinggi target
      body.style.maxHeight = '0';
      body.style.visibility = '';
      requestAnimationFrame(() => {
        body.style.maxHeight = _manageListHeight + 'px';
        setTimeout(() => { if(_manageListOpen) body.style.maxHeight = 'none'; }, 400);
      });
    });

    chevron.style.transform = 'rotate(180deg)';
    toggle.style.borderBottomColor = 'rgba(14,165,233,0.12)';

  } else {
    // ‚îÄ‚îÄ Collapse ‚îÄ‚îÄ
    // Pakai cache tinggi ‚Äî hindari baca scrollHeight saat max-height=none (reflow besar)
    const currentHeight = _manageListHeight || body.offsetHeight;
    body.style.maxHeight = currentHeight + 'px';

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        body.style.maxHeight = '0';
      });
    });

    chevron.style.transform = 'rotate(0deg)';
    toggle.style.borderBottomColor = 'transparent';
  }
}

function switchTab(tabName){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const active = document.querySelector(`[data-tab="${tabName}"]`);
  if(active) active.classList.add('active');
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  const view = el(tabName);
  if(view) view.classList.remove('hidden');
  
  if (tabName === 'stockOut') {
    _selectedItems = [];
    renderSelectedItems();
    clearSignature();
  }
  
  renderAll();
}

function addItemToStockOutList() {
  const inputEl = el('stockOutSearch');
  const qtyEl = el('stockOutQty');
  
  const selectedItemId = inputEl.dataset.selectedId;
  const qty = parseInt(qtyEl.value) || 0;
  
  if (!selectedItemId) {
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Barang Belum Dipilih',desc:'Tambahkan minimal 1 barang ke daftar sebelum melanjutkan.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
    return;
  }
  
  const item = _itemMap.get(selectedItemId);
  
  if (!item) {
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Barang Tidak Ditemukan',desc:'Barang yang dipilih tidak ditemukan dalam inventori.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
    return;
  }

  if (qty <= 0) {
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Jumlah Tidak Valid',desc:'Jumlah barang yang dikeluarkan harus lebih dari 0.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
    return;
  }

  if (qty > item.stock) {
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Stok Tidak Cukup',desc:'Stok tidak mencukupi. Stok tersedia: <strong>' + item.stock + '</strong> unit.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
    return;
  }

  const existingIndex = _selectedItems.findIndex(x => x.itemId === item.id);
  if (existingIndex >= 0) {
    const totalQty = _selectedItems[existingIndex].qty + qty;
    if (totalQty > item.stock) {
      showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Stok Tidak Cukup',desc:'Total jumlah melebihi stok yang tersedia: <strong>' + item.stock + '</strong> unit.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
      return;
    }
    _selectedItems[existingIndex].qty = totalQty;
    showNotification('info', 'Jumlah diperbarui', `${item.name}: ${totalQty} unit`);
  } else {
    _selectedItems.push({
      itemId: item.id,
      itemName: item.name,
      category: item.category || '-',
      qty: qty,
      maxStock: item.stock
    });
    showNotification('success', 'Barang ditambahkan', `${item.name}: ${qty} unit`);
  }

  inputEl.value = '';
  inputEl.dataset.selectedId = '';
  qtyEl.value = '';
  hideSuggestions();
  
  renderSelectedItems();
}

function removeItemFromStockOutList(itemId) {
  const item = _selectedItems.find(x => x.itemId === itemId);
  _selectedItems = _selectedItems.filter(x => x.itemId !== itemId);
  renderSelectedItems();
  if (item) {
    showNotification('warning', 'Barang dihapus dari daftar', item.itemName);
  }
}

function renderSelectedItems() {
  const container = el('selectedItemsContainer');
  const listSection = el('selectedItemsList');
  const countEl = el('totalItemsCount');
  
  if (_selectedItems.length === 0) {
    listSection.style.display = 'none';
    return;
  }
  
  listSection.style.display = 'block';
  countEl.textContent = `${_selectedItems.length} item`;
  container.innerHTML = '';
  
  _selectedItems.forEach(item => {
    const card = document.createElement('div');
    card.className = 'selected-item-card';
    card.innerHTML = `
      <div class="selected-item-info">
        <div class="selected-item-name">${escapeHtml(item.itemName)}</div>
        <div class="selected-item-meta">Kategori: ${escapeHtml(item.category)} | Jumlah: ${item.qty} | Stok tersedia: ${item.maxStock}</div>
      </div>
      <div class="selected-item-actions">
        <button class="btn-remove" onclick="removeItemFromStockOutList('${item.itemId}')">Hapus</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function addStock(itemId){
  const item = _itemMap.get(itemId);
  if(!item){ showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Barang Tidak Ditemukan',desc:'Barang tidak ditemukan dalam inventori.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return; }
  
  _currentAddStockItem = item;
  
  el('addStockName').value = item.name || '';
  el('addStockCategory').value = item.category || '';
  el('addStockCurrent').value = item.stock || 0;
  
  el('addStockQuantity').value = '';
  el('addStockNotes').value = '';
  
  el('addStockModal').style.display = 'flex';
  
  setTimeout(() => el('addStockQuantity').focus(), 100);
}

function closeAddStockModal() {
  el('addStockModal').style.display = 'none';
  _currentAddStockItem = null;
}

function saveAddStock() {
  if (!_currentAddStockItem) return;
  
  const addQuantity = parseInt(el('addStockQuantity').value) || 0;
  const notes = (el('addStockNotes').value || '').trim();
  
  if (addQuantity <= 0) {
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Jumlah Tidak Valid',desc:'Jumlah stok yang ditambahkan harus lebih dari 0.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
  }
  
  const itemName = _currentAddStockItem.name;
  const oldStock = _currentAddStockItem.stock;
  const newStock = oldStock + addQuantity;
  
  const addStockTarget = _currentAddStockItem; // capture ref

  closeAddStockModal();
  showConfirmModal({
    icon: 'üì•',
    iconBg: 'linear-gradient(135deg,#ecfdf5,#f0fff8)',
    iconBorder: '#6ee7b7',
    title: 'Tambah Stok?',
    desc: 'Stok <strong>' + escapeHtml(itemName) + '</strong> akan bertambah dari <strong>' + oldStock + '</strong> menjadi <strong>' + newStock + '</strong> unit (+' + addQuantity + ').',
    okLabel: 'Ya, Tambah Stok',
    okClass: 'green',
    onConfirm: () => {
      if (addStockTarget) {
        addStockTarget.stock = newStock;
        state.history.push({
          id: uid(),
          itemId: addStockTarget.id,
          itemName: addStockTarget.name, // Bug fix: simpan nama agar tetap tampil jika barang dihapus
          type: 'in',
          qty: addQuantity,
          date: new Date().toISOString(),
          recipient: 'System',
          note: notes || 'Penambahan stok'
        });
      }
      save();
      renderAll();
      showNotification('success', 'Stok berhasil ditambahkan!', itemName + ': ' + oldStock + ' ‚Üí ' + newStock + ' (+' + addQuantity + ')');
    }
  });
}

function editItem(itemId){
  const item = _itemMap.get(itemId);
  if(!item){ showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Barang Tidak Ditemukan',desc:'Barang tidak ditemukan dalam inventori.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return; }
  
  _currentEditItem = item;
  
  el('editName').value = item.name || '';
  el('editCategory').value = item.category || '';
  el('editStock').value = item.stock || 0;
  el('editBarcode').value = item.barcode || '';
  
  el('editModal').style.display = 'flex';
  
  setTimeout(() => el('editName').focus(), 100);
}

function closeEditModal() {
  el('editModal').style.display = 'none';
  _currentEditItem = null;
}

function saveEditItem() {
  if (!_currentEditItem) return;
  
  const newName = el('editName').value.trim();
  const newCategory = el('editCategory').value.trim();
  const newStock = parseInt(el('editStock').value) || 0;
  const newBarcode = el('editBarcode').value.trim();
  
  if (!newName) {
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Nama Kosong',desc:'Nama barang tidak boleh kosong.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
  }
  
  const oldName     = _currentEditItem.name;
  const oldCategory = _currentEditItem.category;
  const oldStock    = _currentEditItem.stock;
  const oldBarcode  = _currentEditItem.barcode;
  const editTarget  = _currentEditItem; // capture ref before modal closes

  // Cek duplikat nama ‚Äî kecualikan barang itu sendiri
  const dupName = state.items.find(x =>
    x.id !== editTarget.id &&
    x.name.trim().toLowerCase() === newName.toLowerCase()
  );
  if (dupName) {
    showConfirmModal({
      icon: '‚ö†Ô∏è',
      iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)',
      iconBorder: '#fde68a',
      title: 'Nama Barang Sudah Ada',
      desc: 'Barang dengan nama <strong>' + escapeHtml(newName) + '</strong> sudah ada di inventori (kategori: <strong>' + escapeHtml(dupName.category || '-') + '</strong>).<br><br>Gunakan nama yang berbeda.',
      okLabel: 'OK',
      okClass: 'primary',
      onConfirm: () => {}
    });
    return;
  }

  // Cek duplikat barcode ‚Äî kecualikan barang itu sendiri, hanya jika barcode diisi
  if (newBarcode) {
    const dupBarcode = state.items.find(x =>
      x.id !== editTarget.id &&
      x.barcode && x.barcode.trim().toLowerCase() === newBarcode.toLowerCase()
    );
    if (dupBarcode) {
      showConfirmModal({
        icon: '‚ö†Ô∏è',
        iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)',
        iconBorder: '#fde68a',
        title: 'Barcode Sudah Digunakan',
        desc: 'Barcode <strong>' + escapeHtml(newBarcode) + '</strong> sudah digunakan oleh barang <strong>' + escapeHtml(dupBarcode.name) + '</strong>.<br><br>Setiap barang harus memiliki barcode yang unik.',
        okLabel: 'OK',
        okClass: 'primary',
        onConfirm: () => {}
      });
      return;
    }
  }

  // Catat perubahan yang terjadi
  const changes = [];
  if (oldName     !== newName)     changes.push('Nama: "' + oldName + '" -> "' + newName + '"');
  if (oldCategory !== newCategory) changes.push('Kategori: "' + (oldCategory||'-') + '" -> "' + (newCategory||'-') + '"');
  if (oldStock    !== newStock)    changes.push('Stok: ' + oldStock + ' -> ' + newStock);
  if (oldBarcode  !== newBarcode)  changes.push('Barcode: "' + (oldBarcode||'-') + '" -> "' + (newBarcode||'-') + '"');

  closeEditModal();
  showConfirmModal({
    icon: '‚úèÔ∏è',
    iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)',
    iconBorder: '#fde68a',
    title: 'Simpan Perubahan?',
    desc: 'Perubahan pada barang <strong>' + escapeHtml(newName) + '</strong> akan disimpan.' + (changes.length > 0 ? '<br><span style="font-size:12px;color:var(--text-3);">' + changes.map(c => escapeHtml(c)).join(' | ') + '</span>' : ''),
    okLabel: 'Ya, Simpan',
    okClass: 'primary',
    onConfirm: () => {
      editTarget.name     = newName;
      editTarget.category = newCategory;
      editTarget.stock    = newStock;
      editTarget.barcode  = newBarcode;
      state.history.push({
        id: uid(),
        itemId: editTarget.id,
        itemName: newName, // Bug fix: simpan nama agar tetap tampil jika barang dihapus
        type: 'edit',
        qty: 0,
        date: new Date().toISOString(),
        recipient: 'System',
        note: changes.length > 0 ? changes.join(' | ') : 'Tidak ada perubahan data'
      });
      save();
      renderAll();
      showNotification('success', 'Barang berhasil diperbarui', newName + ' telah diperbarui');
    }
  });
}

const NOTIF_ICONS = {
  success: '<path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/>',
  error:   '<path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>',
  warning: '<path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>',
  info:    '<path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>',
};

// ‚îÄ‚îÄ Notification queue system ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _notifQueue = [];
let _notifActive = false;

function showNotification(type = 'info', title, message = null) {
  _notifQueue.push({ type, title, message });
  if (!_notifActive) _processNotifQueue();
}

function _processNotifQueue() {
  if (_notifQueue.length === 0) { _notifActive = false; return; }
  _notifActive = true;

  const { type, title, message } = _notifQueue.shift();

  try {
    // Hapus toast aktif yang masih ada (fail-safe)
    document.querySelectorAll('.notification').forEach(n => n.remove());

    const notification = document.createElement('div');
    notification.className = `notification ${type} ${message ? '' : 'single-line'}`;
    notification.setAttribute('role', 'status');
    notification.setAttribute('aria-live', 'polite');
    const iconSvg = NOTIF_ICONS[type] || NOTIF_ICONS.info;

    notification.innerHTML = `
      <div class="notification-content">
        <div class="notification-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            ${iconSvg}
          </svg>
        </div>
        <div class="notification-text">
          <div class="notification-title">${escapeHtml(title)}</div>
          ${message ? `<div class="notification-message">${escapeHtml(message)}</div>` : ''}
        </div>
        <button class="notification-close" aria-label="Tutup">‚úï</button>
      </div>
    `;

    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 50);

    const duration = message ? 4000 : 2800;
    let dismissed = false;

    const dismiss = () => {
      if (dismissed) return;
      dismissed = true;
      notification.classList.add('hiding');
      setTimeout(() => {
        notification.remove();
        // Jeda singkat antar toast agar tidak terasa berdempetan
        setTimeout(_processNotifQueue, 180);
      }, 240);
    };

    const autoTimer = setTimeout(dismiss, duration);
    notification.querySelector('.notification-close').addEventListener('click', () => {
      clearTimeout(autoTimer);
      dismiss();
    }, { once: true });

  } catch(e) {
    console.log(`${type.toUpperCase()}: ${title}${message ? ' - ' + message : ''}`);
    setTimeout(_processNotifQueue, 200);
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL CONFIRMATION SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ 1. Reusable confirm modal (for non-destructive actions) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _confirmCallback = null;

function showConfirmModal({ icon, iconBg, iconBorder, title, desc, okLabel, okClass, onConfirm }) {
  const modal       = el('confirmModal');
  const iconEl      = el('confirmModalIcon');
  const titleEl     = el('confirmModalTitle');
  const descEl      = el('confirmModalDesc');
  const okBtn       = el('confirmModalOk');

  iconEl.style.background = iconBg || 'var(--blue-light)';
  iconEl.style.border     = '2px solid ' + (iconBorder || 'var(--blue-mid)');
  iconEl.textContent      = icon  || '‚ÑπÔ∏è';
  titleEl.textContent     = title || '';
  descEl.innerHTML        = desc  || '';
  okBtn.textContent       = okLabel || 'Konfirmasi';
  okBtn.className         = 'btn ' + (okClass || 'primary');
  okBtn.style.flex        = '1';

  _confirmCallback = onConfirm;
  modal.style.display = 'flex';
}

function closeConfirmModal() {
  el('confirmModal').style.display = 'none';
  _confirmCallback = null;
}

el('confirmModalOk').addEventListener('click', () => {
  const cb = _confirmCallback;
  closeConfirmModal();
  if (typeof cb === 'function') cb();
});
el('confirmModalCancel').addEventListener('click', closeConfirmModal);
el('confirmModal').addEventListener('click', e => { if (e.target === el('confirmModal')) closeConfirmModal(); });

// ‚îÄ‚îÄ 2. Delete item modal (destructive ‚Äî must type HAPUS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _deleteItemCallback = null;

function showDeleteItemModal({ itemName, itemCategory, itemStock, onConfirm }) {
  const modal   = el('deleteItemModal');
  const descEl  = el('deleteItemDesc');
  const input   = el('deleteItemInput');
  const btn     = el('deleteItemConfirmBtn');

  descEl.innerHTML = `Barang <strong>${escapeHtml(itemName)}</strong> akan dihapus permanen dari inventori. Stok saat ini: <strong>${itemStock}</strong> unit. Tindakan ini tidak dapat dibatalkan.`;
  input.value = '';
  btn.disabled = true;
  btn.style.opacity = '0.45';
  btn.style.cursor  = 'not-allowed';

  _deleteItemCallback = onConfirm;
  modal.style.display = 'flex';
  setTimeout(() => input.focus(), 100);
}

function closeDeleteItemModal() {
  el('deleteItemModal').style.display = 'none';
  el('deleteItemInput').value = '';
  _deleteItemCallback = null;
}

el('deleteItemInput').addEventListener('input', () => {
  const btn   = el('deleteItemConfirmBtn');
  const valid = el('deleteItemInput').value.trim() === 'HAPUS';
  btn.disabled      = !valid;
  btn.style.opacity = valid ? '1' : '0.45';
  btn.style.cursor  = valid ? 'pointer' : 'not-allowed';
});
el('deleteItemConfirmBtn').addEventListener('click', () => {
  if (el('deleteItemInput').value.trim() !== 'HAPUS') return;
  const cb = _deleteItemCallback;
  closeDeleteItemModal();
  if (typeof cb === 'function') cb();
});
el('deleteItemCancelBtn').addEventListener('click', closeDeleteItemModal);
el('deleteItemModal').addEventListener('click', e => { if (e.target === el('deleteItemModal')) closeDeleteItemModal(); });


// ‚îÄ‚îÄ Utility: debounce ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function debounce(fn, delay = 200) {
  let timer;
  return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); };
}

// ‚îÄ‚îÄ [FIX-A] Lazy script loader ‚Äî muat library hanya saat dibutuhkan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _loadedScripts = new Set();
function loadScript(url) {
  if (_loadedScripts.has(url)) return Promise.resolve();
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url;
    s.onload  = () => { _loadedScripts.add(url); resolve(); };
    s.onerror = () => reject(new Error('Gagal memuat: ' + url));
    document.head.appendChild(s);
  });
}

// Lazy loader untuk jsPDF + autoTable (dipakai di 3 fungsi PDF)
let _jsPDFLoading = null;
async function ensureJsPDF() {
  if (window.jspdf) return; // sudah dimuat
  if (_jsPDFLoading) return _jsPDFLoading; // sedang dimuat, tunggu
  _jsPDFLoading = (async () => {
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js');
  })();
  await _jsPDFLoading;
}

// Lazy loader untuk html5-qrcode (dipakai hanya saat scanner dibuka)
let _qrLoading = null;
async function ensureHtml5Qrcode() {
  if (window.Html5Qrcode) return; // sudah dimuat
  if (_qrLoading) return _qrLoading;
  _qrLoading = loadScript('https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js');
  await _qrLoading;
}

// Helper: scroll field ke posisi yang tepat, tidak tertutup sticky header
function smoothScrollToField(fieldEl, extraPadding = 16) {
  const header = document.querySelector('.header');
  const headerBottom = header ? header.getBoundingClientRect().bottom : 80;
  const fieldTop = fieldEl.getBoundingClientRect().top;
  const offset = fieldTop - headerBottom - extraPadding;
  if (Math.abs(offset) < 10) return; // sudah di posisi yang baik
  window.scrollBy({ top: offset, behavior: 'smooth' });
}

function initForms(){
  // Auto-scroll saat field nama barang di-focus (konsisten dengan field cari di dashboard)
  const nameInput = el('name');
  if (nameInput) {
    nameInput.addEventListener('focus', () => setTimeout(() => smoothScrollToField(nameInput), 300));
  }

  const addForm = el('addForm');
  addForm.addEventListener('submit', e => {
    e.preventDefault();
    const item = {
      id: uid(),
      name: (el('name').value || '').trim() || 'Untitled',
      category: (el('category').value || '').trim() || '',
      stock: parseInt(el('stock').value) || 0,
      barcode: (el('barcode').value || '').trim()
    };

    // Cek duplikat nama (case-insensitive)
    const dupName = state.items.find(x =>
      x.name.trim().toLowerCase() === item.name.toLowerCase()
    );
    if (dupName) {
      showConfirmModal({
        icon: '‚ö†Ô∏è',
        iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)',
        iconBorder: '#fde68a',
        title: 'Nama Barang Sudah Ada',
        desc: 'Barang dengan nama <strong>' + escapeHtml(item.name) + '</strong> sudah ada di inventori (kategori: <strong>' + escapeHtml(dupName.category || '-') + '</strong>, stok: <strong>' + dupName.stock + '</strong>).<br><br>Gunakan fitur <em>Tambah Stok</em> jika ingin menambah stok barang ini.',
        okLabel: 'OK',
        okClass: 'primary',
        onConfirm: () => {}
      });
      return;
    }

    // Cek duplikat barcode (hanya jika barcode diisi)
    if (item.barcode) {
      const dupBarcode = state.items.find(x =>
        x.barcode && x.barcode.trim().toLowerCase() === item.barcode.toLowerCase()
      );
      if (dupBarcode) {
        showConfirmModal({
          icon: '‚ö†Ô∏è',
          iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)',
          iconBorder: '#fde68a',
          title: 'Barcode Sudah Digunakan',
          desc: 'Barcode <strong>' + escapeHtml(item.barcode) + '</strong> sudah digunakan oleh barang <strong>' + escapeHtml(dupBarcode.name) + '</strong>.<br><br>Setiap barang harus memiliki barcode yang unik.',
          okLabel: 'OK',
          okClass: 'primary',
          onConfirm: () => {}
        });
        return;
      }
    }

    showConfirmModal({
      icon: 'üì¶',
      iconBg: 'linear-gradient(135deg,#ecfdf5,#f0fff8)',
      iconBorder: '#6ee7b7',
      title: 'Tambah Barang Baru?',
      desc: 'Barang <strong>' + escapeHtml(item.name) + '</strong> akan ditambahkan ke inventori dengan stok awal <strong>' + item.stock + '</strong> unit.',
      okLabel: 'Ya, Tambahkan',
      okClass: 'green',
      onConfirm: () => {
        state.items.push(item);
        state.history.push({
          id: uid(),
          itemId: item.id,
          itemName: item.name, // Bug fix: simpan nama agar tetap tampil jika barang dihapus
          type: 'add',
          qty: item.stock,
          date: new Date().toISOString(),
          recipient: 'System',
          note: 'Barang baru ditambahkan. Kategori: ' + (item.category || '-') + '. Stok awal: ' + item.stock + (item.barcode ? '. Barcode: ' + item.barcode : '')
        });
        save(); renderAll();
        addForm.reset();
        showNotification('success', 'Barang berhasil ditambahkan!', item.name + ' dengan stok ' + item.stock + ' telah ditambahkan');
      }
    });
  });

  const stockOutForm = el('stockOutForm');
  stockOutForm.addEventListener('submit', async e => {
    e.preventDefault();
    
    if (_selectedItems.length === 0) {
      showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Daftar Barang Kosong',desc:'Tambahkan minimal 1 barang ke daftar sebelum melanjutkan.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
    }
    
    const recipient = (el('stockOutRecipient').value || '').trim();
    const notes = (el('stockOutNotes').value || '').trim();
    
    if(!recipient){ 
      showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Nama Penerima Kosong',desc:'Nama penerima harus diisi sebelum melanjutkan.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return; 
    }
    
    // Validasi tanda tangan
    if (!isSignatureValid()) {
      showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Tanda Tangan Diperlukan',desc:'Tanda tangan penerima harus diisi sebelum melanjutkan.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
    }
    
    // Dapatkan signature data ‚Äì kompres ke JPEG dengan background putih
    // (jsPDF 2.5.1 tidak mendukung WebP; JPEG jauh lebih kecil dari PNG dan tetap tajam untuk cetak)
    let signatureImage;
    try {
      const offCanvas = document.createElement('canvas');
      offCanvas.width  = _signatureCanvas.width;
      offCanvas.height = _signatureCanvas.height;
      const offCtx = offCanvas.getContext('2d');
      // Isi background putih agar JPEG tidak transparan/hitam
      offCtx.fillStyle = '#ffffff';
      offCtx.fillRect(0, 0, offCanvas.width, offCanvas.height);
      offCtx.drawImage(_signatureCanvas, 0, 0);
      signatureImage = offCanvas.toDataURL('image/jpeg', 0.92);
    } catch (e) {
      signatureImage = _signatureCanvas.toDataURL('image/png');
    }
    
    for (let selectedItem of _selectedItems) {
      const item = _itemMap.get(selectedItem.itemId);
      if (!item) {
        showConfirmModal({ icon: '‚ö†Ô∏è', iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)', iconBorder: '#fde68a', title: 'Barang Tidak Ditemukan', desc: 'Barang <strong>' + escapeHtml(selectedItem.itemName) + '</strong> tidak ditemukan dalam inventori.', okLabel: 'OK', okClass: 'primary', onConfirm: () => {} });
        return;
      }
      if (selectedItem.qty > item.stock) {
        showConfirmModal({ icon: '‚ö†Ô∏è', iconBg: 'linear-gradient(135deg,#fffbeb,#fefce8)', iconBorder: '#fde68a', title: 'Stok Tidak Cukup', desc: 'Stok <strong>' + escapeHtml(item.name) + '</strong> tidak cukup. Tersedia: <strong>' + item.stock + '</strong> unit.', okLabel: 'OK', okClass: 'primary', onConfirm: () => {} });
        return;
      }
    }

    const totalItems = _selectedItems.length;
    const totalUnits = _selectedItems.reduce((s, i) => s + i.qty, 0);
    const itemsList = _selectedItems.map(i => escapeHtml(i.itemName) + ' (' + i.qty + ' unit)').join(', ');

    showConfirmModal({
      icon: 'üì§',
      iconBg: 'linear-gradient(135deg,#fff7ed,#ffedd5)',
      iconBorder: '#fdba74',
      title: 'Keluarkan Stok?',
      desc: '<strong>' + totalItems + ' jenis</strong> barang (<strong>' + totalUnits + ' unit</strong>) akan dikeluarkan untuk penerima <strong>' + escapeHtml(recipient) + '</strong>.<br><span style="font-size:12px;color:var(--text-3);">' + itemsList + '</span>',
      okLabel: 'Ya, Keluarkan',
      okClass: 'orange',
      onConfirm: async () => {
        await doStockOut(signatureImage, recipient, notes);
      }
    });
    return; // processing moved to doStockOut()
  });

  // ‚îÄ‚îÄ Helper: execute stock-out after confirmation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function doStockOut(signatureImage, recipient, notes) {
    const processedItems = [];
    const transactionId = uid();
    const transactionDate = new Date().toISOString();

    for (let selectedItem of _selectedItems) {
      const item = _itemMap.get(selectedItem.itemId);
      if (item) {
        item.stock -= selectedItem.qty;
        const historyId = uid();
        state.history.push({
          id: historyId,
          itemId: item.id,
          itemName: item.name, // Bug fix: simpan nama agar tetap tampil jika barang dihapus
          type: 'out',
          qty: selectedItem.qty,
          date: transactionDate,
          recipient: recipient,
          note: notes,
          signatureId: historyId,
          transactionId: transactionId
        });
        try { await saveSignatureToIndexedDB(historyId, signatureImage); } catch(err) { console.error(err); }
        processedItems.push(item.name + ' (' + selectedItem.qty + ' unit)');
      }
    }

    save();
    renderAll();
    stockOutForm.reset();
    _selectedItems = [];
    renderSelectedItems();
    clearSignature();
    showNotification('warning', 'Stok berhasil dikeluarkan', processedItems.length + ' jenis barang untuk ' + recipient);
  }

  const addStockForm = el('addStockForm');
  addStockForm.addEventListener('submit', e => {
    e.preventDefault();
    saveAddStock();
  });
}

function initTabs(){
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => switchTab(t.dataset.tab));
  });
}

function initSearch(){
  const q = el('q');
  q.addEventListener('input', debounce(e => renderItems(e.target.value), 180));
  q.addEventListener('focus', () => setTimeout(() => smoothScrollToField(q), 300));
  
  el('clearSearch').addEventListener('click', () => { q.value = ''; renderItems(); });
  
  const manageSearch = el('manageSearch');
  if (manageSearch) {
    manageSearch.addEventListener('input', debounce(e => renderManageList(e.target.value, _currentManageFilter), 180));
  }
  
  const clearManageSearch = el('clearManageSearch');
  if (clearManageSearch) {
    clearManageSearch.addEventListener('click', () => {
      manageSearch.value = '';
      renderManageList('', _currentManageFilter);
    });
  }
  
  document.querySelectorAll('[data-manage-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-manage-filter]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      _currentManageFilter = btn.dataset.manageFilter;
      renderManageList(manageSearch?.value || '', _currentManageFilter);
    });
  });

  // Category dropdown listener
  const manageCatDropdown = el('manageCategoryDropdown');
  if(manageCatDropdown){
    manageCatDropdown.addEventListener('change', (e) => {
      _currentManageCategoryFilter = e.target.value;
      renderManageList(el('manageSearch')?.value || '', _currentManageFilter);
    });
  }
  
  document.querySelectorAll('[data-history-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-history-filter]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      _currentHistoryFilter = btn.dataset.historyFilter;
      renderHistory();
    });
  });
  
  const historyCategoryFilter = el('historyCategoryFilter');
  if (historyCategoryFilter) {
    historyCategoryFilter.addEventListener('change', (e) => {
      _currentHistoryCategoryFilter = e.target.value;
      renderHistory();
    });
  }

  const historyMonthFilter = el('historyMonthFilter');
  if (historyMonthFilter) {
    historyMonthFilter.addEventListener('change', (e) => {
      _currentHistoryMonthFilter = e.target.value;
      renderHistory();
    });
  }
  
  initStockOutSearch();
}
function initStockOutSearch() {
  const searchInput = el('stockOutSearch');
  const suggestionsDiv = el('stockOutSuggestions');
  
  if (!searchInput || !suggestionsDiv) return;

  // Auto-scroll saat field pilih barang di-focus ‚Äî scroll ke tepi atas kontainer, bukan field
  const stockOutContainer = document.querySelector('.stock-out-title');
  searchInput.addEventListener('focus', () => setTimeout(() => smoothScrollToField(stockOutContainer || searchInput), 300));
  const handleSearch = debounce((query) => {
    if (query.length === 0) {
      hideSuggestions();
      searchInput.dataset.selectedId = '';
      return;
    }
    
    const filtered = state.items.filter(item => 
      item.name.toLowerCase().includes(query) ||
      (item.category && item.category.toLowerCase().includes(query)) ||
      (item.barcode && item.barcode.toLowerCase().includes(query))
    );
    
    if (filtered.length === 0) {
      suggestionsDiv.innerHTML = '<div class="suggestion-no-results">Tidak ada barang yang sesuai</div>';
      suggestionsDiv.classList.add('show');
    } else {
      const frag = document.createDocumentFragment();
      filtered.forEach(item => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        
        const stockClass = item.stock <= 5 ? 'low' : 'available';
        const stockIcon = item.stock <= 5 ? '‚ö†Ô∏è' : '‚úì';
        
        suggestionItem.innerHTML = `
          <div class="suggestion-item-name">${escapeHtml(item.name)}</div>
          <div class="suggestion-item-meta">
            <span>üì¶ ${escapeHtml(item.category || '-')}</span>
            <span class="suggestion-item-stock ${stockClass}">${stockIcon} Stok: ${item.stock}</span>
            ${item.barcode ? `<span>üè∑Ô∏è ${escapeHtml(item.barcode)}</span>` : ''}
          </div>
        `;
        
        suggestionItem.addEventListener('click', () => {
          searchInput.value = item.name;
          searchInput.dataset.selectedId = item.id;
          hideSuggestions();
          
          const qtyInput = el('stockOutQty');
          if (qtyInput) {
            qtyInput.focus();
          }
        });
        
        frag.appendChild(suggestionItem);
      });
      suggestionsDiv.innerHTML = '';
      suggestionsDiv.appendChild(frag);
      suggestionsDiv.classList.add('show');
    }
  }, 180);
  
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    handleSearch(query);
  });
  
  searchInput.addEventListener('blur', () => {
    setTimeout(() => hideSuggestions(), 200);
  });
  
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      hideSuggestions();
    }
  });
}

function hideSuggestions() {
  const suggestionsDiv = el('stockOutSuggestions');
  if (suggestionsDiv) {
    suggestionsDiv.classList.remove('show');
  }
}

function initSignatureCanvas() {
  _signatureCanvas = el('signatureCanvas');
  if (!_signatureCanvas) return;
  
  _signatureCtx = _signatureCanvas.getContext('2d');
  
  // Fungsi untuk mengatur style context
  const setContextStyle = () => {
    _signatureCtx.strokeStyle = '#000';
    _signatureCtx.lineWidth = 2;
    _signatureCtx.lineCap = 'round';
    _signatureCtx.lineJoin = 'round';
  };
  
  setContextStyle();
  
  const getPos = (e) => {
    const rect   = _signatureCanvas.getBoundingClientRect();
    const scaleX = _signatureCanvas.width  / rect.width;
    const scaleY = _signatureCanvas.height / rect.height;
    const src    = e.type.startsWith('touch') ? e.touches[0] : e;
    if (e.type.startsWith('touch')) e.preventDefault();
    return { x: (src.clientX - rect.left) * scaleX, y: (src.clientY - rect.top) * scaleY };
  };

  const startDrawing = (e) => {
    _isDrawing = true;
    setContextStyle();
    const { x, y } = getPos(e);
    _signatureCtx.beginPath();
    _signatureCtx.moveTo(x, y);
  };

  const draw = (e) => {
    if (!_isDrawing) return;
    const { x, y } = getPos(e);
    _signatureCtx.lineTo(x, y);
    _signatureCtx.stroke();
    _signatureCtx.beginPath();
    _signatureCtx.moveTo(x, y);
  };
  
  const stopDrawing = () => {
    if (_isDrawing) {
      _isDrawing = false;
    }
  };
  
  _signatureCanvas.addEventListener('mousedown', startDrawing);
  _signatureCanvas.addEventListener('mousemove', draw);
  _signatureCanvas.addEventListener('mouseup', stopDrawing);
  _signatureCanvas.addEventListener('mouseout', stopDrawing);
  
  _signatureCanvas.addEventListener('touchstart', startDrawing);
  _signatureCanvas.addEventListener('touchmove', draw);
  _signatureCanvas.addEventListener('touchend', stopDrawing);
  
  const clearBtn = el('clearSignature');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearSignature);
  }
}

function clearSignature() {
  if (_signatureCtx && _signatureCanvas) {
    _signatureCtx.clearRect(0, 0, _signatureCanvas.width, _signatureCanvas.height);
  }
}

function isSignatureValid() {
  if (!_signatureCanvas || !_signatureCtx) return false;
  
  const pixelData = _signatureCtx.getImageData(0, 0, _signatureCanvas.width, _signatureCanvas.height);
  const data = pixelData.data;
  
  for (let i = 0; i < data.length; i += 4) {
    if (data[i + 3] !== 0) {
      return true;
    }
  }
  
  return false;
}

// ‚îÄ‚îÄ Cetak PDF per Transaksi (tanda tangan basah) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function printTransactionPDF(txKey) {
  // [FIX-A] Muat jsPDF hanya saat pertama kali dibutuhkan
  try {
    await ensureJsPDF();
  } catch(e) {
    showNotification('error', 'Gagal memuat library PDF', 'Periksa koneksi internet Anda');
    return;
  }
  const { jsPDF } = window.jspdf;
  
  // Kumpulkan semua history entry yang masuk transaksi ini
  const entries = (state.history || []).filter(h => {
    if (h.transactionId === txKey) return true;
    if (!h.transactionId && 'tx_' + h.id === txKey) return true;
    return false;
  });
  
  if (!entries.length) {
    showNotification('error', 'Data transaksi tidak ditemukan');
    return;
  }
  
  const firstEntry = entries[0];
  const recipient  = firstEntry.recipient || '-';
  const txDate     = new Date(firstEntry.date);
  const txNote     = firstEntry.note || '';
  
  const dateStr = txDate.toLocaleDateString('id-ID', {
    weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'
  });
  const timeStr = txDate.toLocaleTimeString('id-ID', {
    hour: '2-digit', minute: '2-digit', hour12: false
  });
  
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const pageW = 210;
  const marginL = 15;
  const marginR = 15;
  const contentW = pageW - marginL - marginR;
  
  // ‚îÄ‚îÄ Kop / Header (ink-saving: no solid fill, border only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Garis border atas tebal (hemat tinta)
  doc.setDrawColor(3, 105, 161);
  doc.setLineWidth(1.2);
  doc.line(0, 0, pageW, 0);
  doc.setLineWidth(0.4);
  doc.line(marginL, 34, pageW - marginR, 34);  // garis pemisah bawah header

  // Teks hitam / biru gelap (hemat tinta)
  doc.setTextColor(3, 105, 161);
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('SiMERY', marginL, 13);

  doc.setFontSize(9);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(60, 80, 100);
  doc.text('Aplikasi Manajemen Inventory', marginL, 19);
  doc.text('Twin Insani, S.Kom', marginL, 24);

  doc.setFontSize(11);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(20, 20, 20);
  doc.text('BUKTI PENGELUARAN BARANG', pageW - marginR, 13, { align: 'right' });
  doc.setFontSize(8);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(60, 80, 100);

  const noDoc = `TRX/${txDate.getFullYear()}/${String(txDate.getMonth()+1).padStart(2,'0')}/${txKey.slice(-6).toUpperCase()}`;
  doc.text(`No: ${noDoc}`, pageW - marginR, 19, { align: 'right' });
  doc.text(`Tanggal: ${dateStr}`, pageW - marginR, 24, { align: 'right' });
  doc.text(`Waktu  : ${timeStr} WIB`, pageW - marginR, 29, { align: 'right' });

  doc.setTextColor(0, 0, 0);
  
  let y = 42;
  
  // ‚îÄ‚îÄ Info Penerima ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  doc.setFillColor(248, 250, 252);   // hampir putih, hemat tinta
  doc.setDrawColor(180, 200, 220);
  doc.roundedRect(marginL, y, contentW, 22, 2, 2, 'FD');
  
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 120);
  doc.text('DISERAHKAN KEPADA', marginL + 4, y + 5);
  doc.setFontSize(13);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(3, 105, 161);
  doc.text(recipient, marginL + 4, y + 13);
  
  if (txNote) {
    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 120);
    doc.text(`Keterangan: ${txNote}`, marginL + 4, y + 19);
  }
  
  doc.setTextColor(0, 0, 0);
  y += 28;
  
  // ‚îÄ‚îÄ Tabel Barang ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  doc.setFontSize(10);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(3, 105, 161);
  doc.text('DAFTAR BARANG YANG DITERIMA', marginL, y);
  doc.setTextColor(0, 0, 0);
  y += 4;
  
  const tableItems = entries.map((h, idx) => {
    // [FIX #3] O(1) lookup
    const item = _itemMap.get(h.itemId);
    return [
      (idx + 1).toString(),
      item?.name || '[dihapus]',
      item?.category || '-',
      h.qty.toString(),
      'unit',
      ''   // kolom paraf
    ];
  });
  
  const totalQty = entries.reduce((s, h) => s + h.qty, 0);
  tableItems.push([
    '', 'TOTAL', '', totalQty.toString(), 'unit', ''
  ]);
  
  doc.autoTable({
    startY: y,
    head: [['No', 'Nama Barang', 'Kategori / Jenis', 'Jml', 'Satuan', 'Paraf']],
    body: tableItems,
    theme: 'grid',
    headStyles: {
      fillColor: [220, 235, 245],   // biru sangat muda, hemat tinta
      textColor: [3, 105, 161],     // teks biru gelap (bukan putih)
      fontStyle: 'bold',
      fontSize: 9,
      halign: 'center',
      lineColor: [180, 210, 230],
      lineWidth: 0.4,
    },
    bodyStyles: {
      fontSize: 9,
      valign: 'middle',
      minCellHeight: 9,
    },
    columnStyles: {
      0: { cellWidth: 10, halign: 'center' },
      1: { cellWidth: 78 },            // diperlebar agar total = 180mm
      2: { cellWidth: 40 },
      3: { cellWidth: 14, halign: 'center' },
      4: { cellWidth: 16, halign: 'center' },
      5: { cellWidth: 22, halign: 'center' },
    },
    didDrawRow: (data) => {
      // Baris total ‚Üí bold dan background terang
      if (data.row.index === tableItems.length - 1) {
        doc.setFillColor(224, 242, 254);
      }
    },
    margin: { left: marginL, right: marginR },
    tableWidth: contentW,
  });
  
  y = doc.lastAutoTable.finalY + 8;
  
  // ‚îÄ‚îÄ Catatan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  doc.setFontSize(8);
  doc.setFont(undefined, 'italic');
  doc.setTextColor(140, 140, 160);
  doc.text('* Barang di atas telah diterima dalam kondisi baik.', marginL, y);
  doc.text('* Dokumen ini berlaku sebagai bukti serah terima barang yang sah.', marginL, y + 4);
  doc.setTextColor(0, 0, 0);
  y += 14;
  
  // ‚îÄ‚îÄ Area Tanda Tangan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Pastikan cukup ruang, jika tidak buat halaman baru
  if (y > 230) {
    doc.addPage();
    y = 20;
  }
  
  // Dua kolom: Penyerah (kiri) | Penerima (kanan)
  const colW   = (contentW - 10) / 2;
  const leftX  = marginL;
  const rightX = marginL + colW + 10;
  
  const boxH   = 50;
  
  // Box kiri ‚Äî Diserahkan oleh
  doc.setDrawColor(180, 200, 220);
  doc.setLineWidth(0.5);
  doc.setFillColor(255, 255, 255);   // putih bersih, hemat tinta
  doc.roundedRect(leftX, y, colW, boxH, 2, 2, 'FD');
  
  doc.setFontSize(8);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(3, 105, 161);
  doc.text('DISERAHKAN OLEH', leftX + colW/2, y + 6, { align: 'center' });
  doc.setFont(undefined, 'normal');
  doc.setTextColor(120, 120, 140);
  doc.text('(Pengurus Barang)', leftX + colW/2, y + 11, { align: 'center' });
  
  // Garis tanda tangan kiri
  doc.setDrawColor(140, 140, 160);
  doc.setLineWidth(0.4);
  doc.line(leftX + 8, y + boxH - 12, leftX + colW - 8, y + boxH - 12);
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 120);
  doc.text('( _________________________ )', leftX + colW/2, y + boxH - 6, { align: 'center' });
  
  // Box kanan ‚Äî Diterima oleh
  doc.setDrawColor(180, 200, 220);
  doc.setLineWidth(0.5);
  doc.setFillColor(255, 255, 255);   // putih bersih, hemat tinta
  doc.roundedRect(rightX, y, colW, boxH, 2, 2, 'FD');
  
  doc.setFontSize(8);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(5, 150, 105);
  doc.text('DITERIMA OLEH', rightX + colW/2, y + 6, { align: 'center' });
  doc.setFont(undefined, 'normal');
  doc.setTextColor(120, 120, 140);
  doc.text(`(${recipient})`, rightX + colW/2, y + 11, { align: 'center' });
  
  // Garis tanda tangan kanan
  doc.setDrawColor(140, 140, 160);
  doc.line(rightX + 8, y + boxH - 12, rightX + colW - 8, y + boxH - 12);
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 120);
  doc.text('( _________________________ )', rightX + colW/2, y + boxH - 6, { align: 'center' });
  
  y += boxH + 10;
  
  // ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  doc.setDrawColor(186, 230, 253);
  doc.setLineWidth(0.5);
  doc.line(marginL, y, pageW - marginR, y);
  
  doc.setFontSize(7.5);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(160, 160, 180);
  const printedAt = new Date().toLocaleString('id-ID', {
    day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'
  });
  doc.text(`Dicetak melalui SiMERY pada ${printedAt} WIB`, pageW/2, y + 5, { align: 'center' });
  doc.text(`No. Dokumen: ${noDoc}`, pageW/2, y + 9, { align: 'center' });
  
  // ‚îÄ‚îÄ Save / Open ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const safeName = recipient.replace(/[^a-zA-Z0-9]/g, '_');
  const dateTag  = txDate.toISOString().split('T')[0];
  const fileName = `Bukti_Serah_Terima_${safeName}_${dateTag}.pdf`;
  
  // Deteksi mobile: buka di tab baru (lebih baik di smartphone)
  const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  if (isMobile) {
    const pdfBlob = doc.output('blob');
    const blobUrl = URL.createObjectURL(pdfBlob);
    const link = document.createElement('a');
    link.href = blobUrl;
    link.download = fileName;
    link.target = '_blank';
    link.rel = 'noopener';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
  } else {
    doc.save(fileName);
  }
  
  showNotification('success', 'PDF berhasil dibuat!', `Bukti serah terima untuk ${recipient}`);
}

async function exportHistoryToPDF() {
  // [FIX-A] Lazy load jsPDF
  try {
    await ensureJsPDF();
  } catch(e) {
    showNotification('error', 'Gagal memuat library PDF', 'Periksa koneksi internet Anda');
    return;
  }
  const { jsPDF } = window.jspdf;

  let filtered = state.history.slice();

  if (_currentHistoryFilter !== 'all') {
    filtered = filtered.filter(h => h.type === _currentHistoryFilter);
  }

  if (_currentHistoryCategoryFilter) {
    filtered = filtered.filter(h => {
      // [FIX #3] O(1) lookup
      const item = _itemMap.get(h.itemId);
      return item && item.category === _currentHistoryCategoryFilter;
    });
  }

  if (filtered.length === 0) {
    showConfirmModal({icon:'‚ÑπÔ∏è',iconBg:'var(--blue-light)',iconBorder:'var(--blue-mid)',title:'Tidak Ada Data',desc:'Tidak ada data riwayat untuk di-export.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
  }

  filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

  // ‚îÄ‚îÄ Grup transaksi (sama persis seperti sebelumnya) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const groupedByRecipient = {};
  filtered.forEach(h => {
    // [FIX #3] O(1) lookup
    const item = _itemMap.get(h.itemId);
    const recipient = h.recipient || 'Tanpa Nama';
    const note = h.note || '-';
    const hDate = new Date(h.date);

    let foundGroup = null;
    for (const key in groupedByRecipient) {
      const group = groupedByRecipient[key];
      const timeDiff = Math.abs(hDate - new Date(group.date));
      if (group.recipient === recipient &&
          group.type === h.type &&
          group.keterangan === note &&
          timeDiff < 5000) {
        foundGroup = key;
        break;
      }
    }

    if (foundGroup) {
      groupedByRecipient[foundGroup].items.push({
        nama: item?.name || '[deleted]',
        kategori: item?.category || 'Tanpa Kategori',
        jumlah: h.qty,
        date: hDate
      });
      // Simpan signatureId pertama yang ditemukan untuk grup ini
      if (!groupedByRecipient[foundGroup].signatureId && h.signatureId) {
        groupedByRecipient[foundGroup].signatureId = h.signatureId;
      }
    } else {
      const transactionKey = `${recipient}_${h.date}_${h.type}_${uid()}`;
      groupedByRecipient[transactionKey] = {
        recipient, type: h.type, date: h.date,
        items: [{ nama: item?.name || '[deleted]', kategori: item?.category || 'Tanpa Kategori', jumlah: h.qty, date: hDate }],
        signatureId: h.signatureId || null,
        keterangan: note
      };
    }
  });

  const sortedTransactions = Object.entries(groupedByRecipient).sort((a, b) =>
    new Date(b[1].date) - new Date(a[1].date)
  );
  const totalTx = sortedTransactions.length;

  // ‚îÄ‚îÄ Tampilkan progress ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Buat elemen progress sementara di atas halaman
  let progressEl = document.getElementById('_pdfProgressToast');
  if (!progressEl) {
    progressEl = document.createElement('div');
    progressEl.id = '_pdfProgressToast';
    progressEl.style.cssText = 'position:fixed;top:76px;left:50%;transform:translateX(-50%);z-index:9999;background:linear-gradient(135deg,#0ea5e9,#06b6d4);color:#fff;padding:12px 24px;border-radius:14px;font-family:inherit;font-size:13px;font-weight:700;box-shadow:0 8px 24px rgba(14,165,233,0.35);width:calc(min(560px,100vw) - 32px);max-width:528px;text-align:center;';
    document.body.appendChild(progressEl);
  }
  const updateProgress = (cur, total, label) => {
    progressEl.textContent = label || `‚è≥ Menyiapkan PDF‚Ä¶ ${cur}/${total} transaksi`;
  };
  updateProgress(0, totalTx, '‚è≥ Memulai export PDF‚Ä¶');

  // Yield ke event loop agar UI sempat render
  await new Promise(r => setTimeout(r, 0));

  // ‚îÄ‚îÄ Buat dokumen PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const doc = new jsPDF();

  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('LAPORAN RIWAYAT INVENTORY', 105, 15, { align: 'center' });

  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  doc.text('SiMERY - Aplikasi Manajemen Inventory', 105, 22, { align: 'center' });

  doc.setFontSize(9);
  const exportDate = new Date().toLocaleString('id-ID', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });
  doc.text(`Dicetak pada: ${exportDate} WIB`, 105, 28, { align: 'center' });

  let yPos = 35;

  doc.setFontSize(9);
  doc.setFont(undefined, 'italic');
  let filterText = 'Filter: ';
  if (_currentHistoryFilter === 'in') filterText += 'Stok Masuk';
  else if (_currentHistoryFilter === 'out') filterText += 'Stok Keluar';
  else filterText += 'Semua';
  if (_currentHistoryCategoryFilter) filterText += ` | Kategori: ${_currentHistoryCategoryFilter}`;
  doc.text(filterText, 14, yPos);
  yPos += 10;

  // ‚îÄ‚îÄ Render transaksi satu per satu (async + yield tiap 10 item) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let transactionNumber = 1;
  for (const [key, transaction] of sortedTransactions) {

    // Update progress setiap transaksi
    updateProgress(transactionNumber, totalTx);

    // Yield ke event loop setiap 10 transaksi agar browser tidak freeze
    if (transactionNumber % 10 === 0) {
      await new Promise(r => setTimeout(r, 0));
    }

    // ‚îÄ‚îÄ Load signature per-transaksi (bukan load semua sekaligus) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let sigData = null;
    if (transaction.signatureId) {
      try {
        sigData = await getSignatureFromIndexedDB(transaction.signatureId);
      } catch(e) {
        console.warn('Gagal load signature:', transaction.signatureId, e);
      }
    }

    // Cek halaman baru
    if (yPos > 220) {
      doc.addPage();
      yPos = 20;
    }

    // Header transaksi
    const transactionDate = new Date(transaction.date);
    const dateStr = transactionDate.toLocaleDateString('id-ID', { day:'2-digit', month:'2-digit', year:'numeric' });
    const timeStr = transactionDate.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', hour12:false });

    let typeLabel, typeColor;
    if      (transaction.type === 'in')     { typeLabel = 'STOK MASUK';          typeColor = [16, 185, 129]; }
    else if (transaction.type === 'out')    { typeLabel = 'STOK KELUAR';         typeColor = [239, 68, 68]; }
    else if (transaction.type === 'add')    { typeLabel = 'BARANG DITAMBAHKAN';  typeColor = [59, 130, 246]; }
    else if (transaction.type === 'edit')   { typeLabel = 'BARANG DIEDIT';       typeColor = [245, 158, 11]; }
    else if (transaction.type === 'delete') { typeLabel = 'BARANG DIHAPUS';      typeColor = [107, 114, 128]; }
    else                                    { typeLabel = 'TRANSAKSI';           typeColor = [100, 116, 139]; }

    doc.setFillColor(...typeColor);
    doc.roundedRect(14, yPos, 182, 12, 2, 2, 'F');
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text(`${typeLabel} - ${transaction.recipient}`, 16, yPos + 5);
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(`${dateStr} | ${timeStr} WIB`, 16, yPos + 10);
    doc.setTextColor(0, 0, 0);
    yPos += 15;

    // Tabel items
    const tableData = transaction.items.map((item, idx) => [
      (idx + 1).toString(), item.nama, item.jumlah.toString(),
      item.kategori, dateStr, `${timeStr} WIB`, transaction.keterangan
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['No', 'Nama Barang', 'Jumlah', 'Jenis Barang', 'Tanggal', 'Waktu', 'Keterangan']],
      body: tableData,
      theme: 'grid',
      headStyles: { fillColor: typeColor, textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 9 },
      bodyStyles: { fontSize: 8, valign: 'middle' },
      columnStyles: {
        0: { cellWidth: 10, halign: 'center' },
        1: { cellWidth: 45 },
        2: { cellWidth: 15, halign: 'center' },
        3: { cellWidth: 30 },
        4: { cellWidth: 22, halign: 'center' },
        5: { cellWidth: 25, halign: 'center' },
        6: { cellWidth: 35 }
      },
      margin: { left: 14, right: 14 }
    });

    yPos = doc.lastAutoTable.finalY + 5;

    // Tanda tangan
    if (sigData) {
      if (yPos > 250) { doc.addPage(); yPos = 20; }
      const signatureWidth = 50;
      const signatureHeight = 20;
      const signatureX = 196 - signatureWidth - 10;

      doc.setFontSize(8);
      doc.setFont(undefined, 'normal');
      const labelWidth = doc.getTextWidth('Tanda Tangan');
      doc.text('Tanda Tangan', signatureX + (signatureWidth - labelWidth) / 2, yPos);
      yPos += 4;

      try {
        const sigFormat = sigData.startsWith('data:image/jpeg') ? 'JPEG' : 'PNG';
        doc.addImage(sigData, sigFormat, signatureX, yPos, signatureWidth, signatureHeight);
        yPos += signatureHeight + 2;
      } catch (e) {
        console.error('Error adding signature to PDF:', e);
        doc.setFontSize(7);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(150, 150, 150);
        const errorWidth = doc.getTextWidth('[Tanda tangan tidak dapat ditampilkan]');
        doc.text('[Tanda tangan tidak dapat ditampilkan]', signatureX + (signatureWidth - errorWidth) / 2, yPos);
        doc.setTextColor(0, 0, 0);
        yPos += 5;
      }

      doc.setFontSize(8);
      doc.setFont(undefined, 'normal');
      const nameText = `(${transaction.recipient})`;
      const nameWidth = doc.getTextWidth(nameText);
      doc.text(nameText, signatureX + (signatureWidth - nameWidth) / 2, yPos);
      yPos += 3;
    } else {
      const signatureWidth = 50;
      const signatureX = 196 - signatureWidth - 10;
      doc.setFontSize(8);
      doc.setFont(undefined, 'italic');
      doc.setTextColor(150, 150, 150);
      const noSignText = 'Tanda Tangan: -';
      const noSignWidth = doc.getTextWidth(noSignText);
      doc.text(noSignText, signatureX + (signatureWidth - noSignWidth) / 2, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 3;
    }

    // Garis pemisah
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(14, yPos + 3, 196, yPos + 3);
    yPos += 10;

    transactionNumber++;

    // Bebaskan referensi signature dari memori setelah dipakai
    sigData = null;
  }

  // ‚îÄ‚îÄ Ringkasan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  updateProgress(totalTx, totalTx, '‚è≥ Menyusun ringkasan‚Ä¶');
  await new Promise(r => setTimeout(r, 0));

  if (yPos > 240) { doc.addPage(); yPos = 20; }

  doc.setDrawColor(100, 100, 100);
  doc.setLineWidth(1);
  doc.line(14, yPos, 196, yPos);
  yPos += 8;

  doc.setFontSize(11);
  doc.setFont(undefined, 'bold');
  doc.text('RINGKASAN', 14, yPos);
  yPos += 8;

  const totalTransactions = sortedTransactions.length;
  const totalIn  = sortedTransactions.filter(([k, t]) => t.type === 'in').length;
  const totalOut = sortedTransactions.filter(([k, t]) => t.type === 'out').length;
  const totalAdd = sortedTransactions.filter(([k, t]) => t.type === 'add').length;
  const totalEdit   = sortedTransactions.filter(([k, t]) => t.type === 'edit').length;
  const totalDelete = sortedTransactions.filter(([k, t]) => t.type === 'delete').length;

  const totalItemsIn  = sortedTransactions.filter(([k,t])=>t.type==='in').reduce((s,[k,t])=>s+t.items.reduce((a,i)=>a+i.jumlah,0),0);
  const totalItemsOut = sortedTransactions.filter(([k,t])=>t.type==='out').reduce((s,[k,t])=>s+t.items.reduce((a,i)=>a+i.jumlah,0),0);
  const totalItemsAdd = sortedTransactions.filter(([k,t])=>t.type==='add').reduce((s,[k,t])=>s+t.items.reduce((a,i)=>a+i.jumlah,0),0);

  doc.setFont(undefined, 'normal');
  doc.setFontSize(9);
  doc.text(`Total Entri: ${totalTransactions}`, 14, yPos); yPos += 5;
  doc.text(`  - Stok Masuk: ${totalIn} transaksi (${totalItemsIn} unit)`, 14, yPos); yPos += 5;
  doc.text(`  - Stok Keluar: ${totalOut} transaksi (${totalItemsOut} unit)`, 14, yPos); yPos += 5;
  if (totalAdd > 0)    { doc.text(`  - Barang Ditambahkan: ${totalAdd} (${totalItemsAdd} unit stok awal)`, 14, yPos); yPos += 5; }
  if (totalEdit > 0)   { doc.text(`  - Barang Diedit: ${totalEdit}`, 14, yPos); yPos += 5; }
  if (totalDelete > 0) { doc.text(`  - Barang Dihapus: ${totalDelete}`, 14, yPos); yPos += 5; }
  yPos += 3;

  const uniqueRecipients = new Set(sortedTransactions.map(([k, t]) => t.recipient));
  doc.text(`Total Penerima/Pengirim Berbeda: ${uniqueRecipients.size}`, 14, yPos);

  // ‚îÄ‚îÄ Simpan PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  updateProgress(totalTx, totalTx, '‚è≥ Menyimpan file‚Ä¶');
  await new Promise(r => setTimeout(r, 0));

  const fileName = `Riwayat_Inventory_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);

  // Hapus progress toast
  if (progressEl && progressEl.parentNode) progressEl.parentNode.removeChild(progressEl);

  showNotification('success', 'PDF berhasil di-export!', `File: ${fileName}`);
}
async function exportPerItemPDF() {
  // [FIX-A] Lazy load jsPDF
  try {
    await ensureJsPDF();
  } catch(e) {
    showNotification('error', 'Gagal memuat library PDF', 'Periksa koneksi internet Anda');
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  if (state.items.length === 0) {
    showConfirmModal({icon:'‚ÑπÔ∏è',iconBg:'var(--blue-light)',iconBorder:'var(--blue-mid)',title:'Tidak Ada Data',desc:'Tidak ada data barang untuk di-export.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
  }

  const sanitize = (v) => (v === null || v === undefined || v === '' ? '-' : String(v).replace(/&/g, 'dan'));

  // [FIX #3] Pre-group history by itemId sekali, O(n), daripada filter O(n) per item
  const historyByItem = {};
  (state.history || []).forEach(h => {
    if (!historyByItem[h.itemId]) historyByItem[h.itemId] = [];
    historyByItem[h.itemId].push(h);
  });

  const itemStats = state.items.map(item => {
    const itemHistory = historyByItem[item.id] || [];
    const stockIn = itemHistory.filter(h => h.type === 'in').reduce((sum, h) => sum + h.qty, 0);
    const stockOut = itemHistory.filter(h => h.type === 'out').reduce((sum, h) => sum + h.qty, 0);
    return {
      nama: sanitize(item.name),
      kategori: sanitize(item.category || 'Tanpa Kategori'),
      barcode: sanitize(item.barcode || '-'),
      masuk: stockIn,
      keluar: stockOut,
      sisa: item.stock || 0,
      transaksi: itemHistory.length
    };
  });

  const grouped = {};
  itemStats.forEach(it => {
    if (!grouped[it.kategori]) grouped[it.kategori] = [];
    grouped[it.kategori].push(it);
  });

  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('LAPORAN STOK PER BARANG', 105, 15, { align: 'center' });

  doc.setFontSize(11);
  doc.text('SiMERY - Aplikasi Manajemen Inventory', 105, 22, { align: 'center' });

  doc.setFontSize(9);
  const exportDate = new Date().toLocaleString('id-ID', {
    day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
  });
  doc.text(`Dicetak pada: ${exportDate} WIB`, 105, 28, { align: 'center' });

  let yPos = 38;
  doc.setFontSize(10);
  doc.setFont(undefined, 'bold');
  doc.text('Ringkasan', 14, yPos);
  yPos += 6;

  const totalMasuk = itemStats.reduce((s, i) => s + i.masuk, 0);
  const totalKeluar = itemStats.reduce((s, i) => s + i.keluar, 0);
  const totalSisa = itemStats.reduce((s, i) => s + i.sisa, 0);

  doc.setFont(undefined, 'normal');
  doc.setFontSize(9);
  doc.text(`Total Barang: ${itemStats.length}`, 14, yPos); yPos += 5;
  doc.text(`Total Masuk: ${totalMasuk}`, 14, yPos); yPos += 5;
  doc.text(`Total Keluar: ${totalKeluar}`, 14, yPos); yPos += 5;
  doc.text(`Total Stok Sekarang: ${totalSisa}`, 14, yPos); yPos += 10;

  doc.setFontSize(11);
  doc.setFont(undefined, 'bold');
  doc.text('DETAIL PER KATEGORI', 14, yPos);
  yPos += 8;

  Object.keys(grouped).forEach((kategori, idx) => {
    if (yPos > 250) { doc.addPage(); yPos = 20; }

    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(47, 155, 74);
    doc.text(`${idx + 1}. ${kategori}`, 14, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 4;

    const body = grouped[kategori].map(it => [
      it.nama,
      it.barcode,
      it.masuk.toString(),
      it.keluar.toString(),
      it.sisa.toString(),
      it.transaksi.toString()
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['Nama Barang', 'Barcode', 'Masuk', 'Keluar', 'Sisa', 'Transaksi']],
      body,
      theme: 'grid',
      headStyles: { fillColor: [47, 155, 74], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 9 },
      bodyStyles: { fontSize: 8 },
      margin: { left: 14, right: 14 },
      columnStyles: {
        0: { cellWidth: 55 },
        1: { cellWidth: 30 },
        2: { cellWidth: 20, halign: 'center' },
        3: { cellWidth: 20, halign: 'center' },
        4: { cellWidth: 20, halign: 'center' },
        5: { cellWidth: 22, halign: 'center' }
      },
      didDrawCell: (data) => {
        if (data.section === 'body' && data.column.index === 4) {
          const stockVal = parseInt(data.cell.text[0]);
          if (stockVal <= 5) {
            doc.setFillColor(239, 68, 68, 0.1);
            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
            doc.setTextColor(239, 68, 68);
            doc.setFont(undefined, 'bold');
            doc.text(data.cell.text[0], data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, {
              align: 'center', baseline: 'middle'
            });
            doc.setTextColor(0, 0, 0);
          }
        }
      }
    });

    yPos = doc.lastAutoTable.finalY + 8;
  });

  const fileName = `Laporan_Stok_Per_Barang_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
  showNotification('success', 'PDF berhasil di-export!', `File: ${fileName}`);
}

async function openScanner(onScan){
  el('scannerModal').style.display = 'flex';
  
  // Reset status
  const statusText = document.querySelector('.scanner-status-text');
  const statusDot  = document.querySelector('.scanner-status-dot');
  if (statusText) statusText.textContent = 'Memuat library scanner‚Ä¶';
  if (statusDot)  statusDot.style.background = 'rgba(255,255,255,0.4)';

  // [FIX-A] Lazy load html5-qrcode hanya saat scanner pertama kali dibuka
  try {
    await ensureHtml5Qrcode();
  } catch(e) {
    if (statusText) statusText.textContent = 'Gagal memuat scanner ‚Äî cek koneksi';
    if (statusDot)  statusDot.style.background = 'var(--danger)';
    showNotification('error', 'Gagal memuat library scanner', 'Periksa koneksi internet Anda');
    return;
  }

  if (statusText) statusText.textContent = 'Memulai kamera‚Ä¶';
  
  if(_scanner){
    try{ _scanner.stop().then(()=> _scanner.clear()); } catch(e){ console.warn('Scanner cleanup error:', e); }
    _scanner = null;
  }
  
  const reader = el('reader');
  reader.innerHTML = '';
  
  // Disable verbose logging & camera-select UI from the library
  Html5Qrcode.LOGGERS = [];
  const html5QrCode = new Html5Qrcode("reader", { verbose: false });
  _scanner = html5QrCode;
  
  const config = {
    fps: 12,
    qrbox: function(viewfinderWidth, viewfinderHeight) {
      const minDimension = Math.min(viewfinderWidth, viewfinderHeight);
      return { width: Math.floor(minDimension * 0.65), height: Math.floor(minDimension * 0.65) };
    },
    aspectRatio: 1.0,
    disableFlip: false,
  };
  
  html5QrCode.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      // Success ‚Äî flash status green
      if (statusText) statusText.textContent = '‚úì Barcode terdeteksi!';
      if (statusDot)  statusDot.style.background = '#10b981';
      try {
        if(typeof onScan === 'function') {
          onScan(decodedText);
        } else {
          el('q').value = decodedText;
          renderItems(decodedText);
          showNotification('success', 'Barcode berhasil discan!');
        }
      } catch(e){ 
        console.error('onScan error', e);
        showNotification('error', 'Error memproses barcode');
      }
      closeScanner();
    },
    (_error) => { /* silent scan errors are normal */ }
  ).then(() => {
    // Camera started OK
    if (statusText) statusText.textContent = 'Menunggu barcode‚Ä¶';
    if (statusDot)  statusDot.style.background = 'var(--blue-1)';
    // Nuke any injected UI elements from the lib after it renders
    setTimeout(() => {
      reader.querySelectorAll('select, button, img[alt], span:not([class]), p, label, #html5-qrcode-header, [id*="html5-qrcode-button"], [id*="html5-qrcode-anchor"]').forEach(node => {
        node.style.cssText = 'display:none!important;visibility:hidden!important;height:0!important;overflow:hidden!important;';
      });
    }, 80);
  }).catch(err => {
    console.error('Scanner start error:', err);
    _scanner = null; // scanner never started, clear the ref
    if (statusText) statusText.textContent = 'Gagal mengakses kamera ‚Äî Tutup & coba lagi';
    if (statusDot)  statusDot.style.background = 'var(--danger)';
    showNotification('error', 'Gagal mengakses kamera', 'Pastikan izin kamera sudah diberikan');
    // Don't auto-close ‚Äî let the user tap close themselves
  });
}

function closeScanner(){
  // Always hide the modal immediately ‚Äî never block on scanner cleanup
  el('scannerModal').style.display = 'none';

  // Reset status UI for next open
  const statusText = document.querySelector('.scanner-status-text');
  const statusDot  = document.querySelector('.scanner-status-dot');
  if (statusText) statusText.textContent = 'Menunggu barcode‚Ä¶';
  if (statusDot)  { statusDot.style.background = 'var(--blue-1)'; }

  // Clean up scanner in background ‚Äî errors are silently swallowed
  if (_scanner) {
    const scannerRef = _scanner;
    _scanner = null;
    try {
      const stopPromise = scannerRef.stop();
      if (stopPromise && typeof stopPromise.then === 'function') {
        stopPromise
          .then(() => { try { scannerRef.clear(); } catch(e){} })
          .catch(() => { try { scannerRef.clear(); } catch(e){} });
      }
    } catch(e) {
      try { scannerRef.clear(); } catch(e2) {}
    }
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  // [FIX #8] Sembunyikan konten selama inisialisasi untuk cegah flash of empty content
  const appEl = document.querySelector('.app');
  if (appEl) appEl.classList.add('app-loading');

  // Initialize IndexedDB first
  try {
    await initIndexedDB();
    console.log('IndexedDB ready');
  } catch(error) {
    console.error('Failed to initialize IndexedDB:', error);
    showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Peringatan',desc:'Penyimpanan tanda tangan mungkin tidak berfungsi dengan baik di browser ini.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}}); return;
  }
  
  await load();
  initTabs();
  initForms();
  initSearch();
  initSignatureCanvas();
  renderAll();

  // [FIX #8] Tampilkan konten setelah data siap (fade-in)
  if (appEl) appEl.classList.remove('app-loading');

  el('scanBarcodeBtn').addEventListener('click', () => {
    openScanner(code => { 
      el('barcode').value = code; 
      showNotification('success', 'Barcode berhasil diisi'); 
    });
  });
  
  el('scanStockOutBtn').addEventListener('click', () => {
    openScanner(code => {
      const item = state.items.find(x => x.barcode && x.barcode.toLowerCase() === code.toLowerCase());
      if (item) {
        const searchInput = el('stockOutSearch');
        searchInput.value = item.name;
        searchInput.dataset.selectedId = item.id;
        showNotification('success', 'Barcode terdeteksi!', `${item.name} dipilih`);
        
        // Delay focus agar user melihat toast notification terlebih dahulu
        setTimeout(() => {
          const qtyInput = el('stockOutQty');
          if (qtyInput) {
            // Scroll smooth ke input field
            qtyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Focus setelah scroll selesai
            setTimeout(() => qtyInput.focus(), 300);
          }
        }, 1500); // Delay 1.5 detik agar toast terlihat
      } else {
        showNotification('warning', 'Barcode tidak ditemukan', 'Barang dengan barcode ini tidak ada di inventory');
      }
    });
  });
  
  el('editScanBarcodeBtn').addEventListener('click', () => {
    openScanner(code => { 
      el('editBarcode').value = code; 
      showNotification('success', 'Barcode berhasil diisi'); 
    });
  });
  
  el('closeScanner').addEventListener('click', closeScanner);

  el('scannerModal').addEventListener('click', (e) => {
    if (e.target === el('scannerModal')) {
      closeScanner();
    }
  });

  const editForm = el('editForm');
  if (editForm) {
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveEditItem();
    });
  }
  
  el('cancelEdit').addEventListener('click', closeEditModal);
  
  el('cancelAddStock').addEventListener('click', closeAddStockModal);
  
  el('addStockModal').addEventListener('click', (e) => {
    if (e.target === el('addStockModal')) {
      closeAddStockModal();
    }
  });
  
  el('editModal').addEventListener('click', (e) => {
    if (e.target === el('editModal')) {
      closeEditModal();
    }
  });
  
  el('addItemToList').addEventListener('click', addItemToStockOutList);
  
  el('exportPdfBtn').addEventListener('click', exportHistoryToPDF);
  
  el('exportPerItemBtn').addEventListener('click', exportPerItemPDF);


  // ‚îÄ‚îÄ Backup & Restore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _restoreData = null;

  el('backupDataBtn').addEventListener('click', () => {
    const totalItems   = (state.items   || []).length;
    const totalHistory = (state.history || []).length;

    showConfirmModal({
      icon: 'üì•',
      iconBg: 'linear-gradient(135deg,#ecfdf5,#d1fae5)',
      iconBorder: '#6ee7b7',
      title: 'Unduh Backup Data?',
      desc: 'File backup akan berisi <strong>' + totalItems + ' barang</strong> dan <strong>' + totalHistory + ' riwayat</strong>.',
      okLabel: 'Ya, Unduh',
      okClass: 'green',
      onConfirm: () => {
        const backup = {
          version: 1,
          exportedAt: new Date().toISOString(),
          appName: 'SiMERY',
          items: state.items   || [],
          history: state.history || [],
          lastModified: state.lastModified || Date.now()
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        const ts   = new Date().toISOString().slice(0,10);
        a.href     = url;
        a.download = 'simery_backup_' + ts + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('success', 'Backup berhasil diunduh', 'File simery_backup_' + ts + '.json tersimpan.');
      }
    });
  });

  window.handleRestoreFile = function(input) {
    const file = input.files[0];
    if (!file) return;
    readRestoreFile(file);
  };

  window.handleRestoreDrop = function(event) {
    event.preventDefault();
    const zone = el('restoreDropZone');
    zone.style.borderColor = 'var(--border)';
    zone.style.background  = 'var(--bg)';
    const file = event.dataTransfer.files[0];
    if (!file) return;
    readRestoreFile(file);
  };

  function readRestoreFile(file) {
    if (!file.name.endsWith('.json')) {
      showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'Format Tidak Valid',desc:'Pilih file <strong>.json</strong> yang merupakan hasil backup SiMERY.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        if (!Array.isArray(parsed.items)) throw new Error('invalid');
        _restoreData = parsed;
        const nameEl = el('restoreFileName');
        nameEl.textContent = '‚úì ' + file.name + ' (' + (parsed.items.length) + ' barang, ' + ((parsed.history||[]).length) + ' riwayat)';
        nameEl.style.display = 'block';
        const btn = el('restoreDataBtn');
        btn.disabled      = false;
        btn.style.opacity = '1';
        btn.style.cursor  = 'pointer';
      } catch(err) {
        showConfirmModal({icon:'‚ö†Ô∏è',iconBg:'linear-gradient(135deg,#fffbeb,#fefce8)',iconBorder:'#fde68a',title:'File Tidak Valid',desc:'File yang dipilih bukan file backup SiMERY yang valid.',okLabel:'OK',okClass:'primary',onConfirm:()=>{}});
        _restoreData = null;
      }
    };
    reader.readAsText(file);
  }

  el('restoreDataBtn').addEventListener('click', () => {
    if (!_restoreData) return;
    const itemCount    = (_restoreData.items   || []).length;
    const historyCount = (_restoreData.history || []).length;
    const exportedAt   = _restoreData.exportedAt ? new Date(_restoreData.exportedAt).toLocaleString('id-ID') : '-';

    showConfirmModal({
      icon: 'üì§',
      iconBg: 'linear-gradient(135deg,#eff6ff,#dbeafe)',
      iconBorder: '#93c5fd',
      title: 'Restore Data?',
      desc: 'Data saat ini akan <strong>digantikan sepenuhnya</strong> oleh:<br><span style="font-size:12px;color:var(--text-3);">üì¶ ' + itemCount + ' barang &nbsp;¬∑&nbsp; üìã ' + historyCount + ' riwayat &nbsp;¬∑&nbsp; üïê Backup: ' + exportedAt + '</span><br><br><strong>Pastikan Anda sudah backup data saat ini.</strong>',
      okLabel: 'Ya, Restore Sekarang',
      okClass: 'primary',
      onConfirm: async () => {
        state.items        = _restoreData.items   || [];
        state.history      = _restoreData.history || [];
        state.lastModified = Date.now();
        buildItemMap(); // Bug fix: rebuild map setelah restore agar filter & lookup benar
        await idbPutState(state);
        if (typeof syncToDrive === 'function') syncToDrive(state);
        renderAll();
        // Reset file input UI
        _restoreData = null;
        el('restoreFileName').style.display = 'none';
        el('restoreFileName').textContent   = '';
        el('restoreFileInput').value        = '';
        const btn = el('restoreDataBtn');
        btn.disabled      = true;
        btn.style.opacity = '0.45';
        btn.style.cursor  = 'not-allowed';
        showNotification('success', 'Data berhasil di-restore', itemCount + ' barang dan ' + historyCount + ' riwayat telah dipulihkan.');
      }
    });
  });

  // ‚îÄ‚îÄ Hapus Semua Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const deleteAllModal    = el('deleteAllModal');
  const deleteConfirmInput= el('deleteConfirmInput');
  const confirmDeleteBtn  = el('confirmDeleteBtn');
  const cancelDeleteBtn   = el('cancelDeleteBtn');

  el('deleteAllDataBtn').addEventListener('click', () => {
    deleteConfirmInput.value = '';
    confirmDeleteBtn.disabled = true;
    confirmDeleteBtn.style.opacity = '0.45';
    confirmDeleteBtn.style.cursor = 'not-allowed';
    deleteAllModal.style.display = 'flex';
    setTimeout(() => deleteConfirmInput.focus(), 100);
  });

  deleteConfirmInput.addEventListener('input', () => {
    const valid = deleteConfirmInput.value.trim() === 'HAPUS';
    confirmDeleteBtn.disabled = !valid;
    confirmDeleteBtn.style.opacity = valid ? '1' : '0.45';
    confirmDeleteBtn.style.cursor = valid ? 'pointer' : 'not-allowed';
  });

  cancelDeleteBtn.addEventListener('click', () => {
    deleteAllModal.style.display = 'none';
    deleteConfirmInput.value = '';
  });

  deleteAllModal.addEventListener('click', (e) => {
    if(e.target === deleteAllModal){
      deleteAllModal.style.display = 'none';
      deleteConfirmInput.value = '';
    }
  });

  confirmDeleteBtn.addEventListener('click', async () => {
    if(deleteConfirmInput.value.trim() !== 'HAPUS') return;
    state.items = [];
    state.history = [];
    state.lastModified = Date.now();
    buildItemMap(); // Bug fix: rebuild map setelah data dihapus
    await idbPutState(state);
    if (typeof debouncedSyncToDrive === 'function') debouncedSyncToDrive(state); // Bug fix: sync ke Drive
    renderAll();
    deleteAllModal.style.display = 'none';
    deleteConfirmInput.value = '';
    showNotification('success', 'Data Dihapus', 'Seluruh data barang dan riwayat berhasil dihapus.');
  });
});
</script>
<script>
// ‚îÄ‚îÄ‚îÄ Google Drive Sync + Offline-First Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚ö†Ô∏è  KEAMANAN ‚Äî API Key & Client ID [FIX-D / AUDIT P0]
// Kredensial di bawah terlihat di source code (view-source). Ini AMAN selama:
// 1. CLIENT_ID  ‚Üí Google Cloud Console > OAuth > "Authorized JavaScript origins"
//    hanya berisi domain produksi Anda (mis. https://inventori.namadomain.com)
//    Kunjungi: https://console.cloud.google.com/apis/credentials
// 2. API_KEY    ‚Üí Google Cloud Console > API & Services > Credentials > Restrict Key
//    a. "Application restrictions" ‚Üí HTTP referrers ‚Üí tambah domain Anda + localhost
//    b. "API restrictions"         ‚Üí Drive API saja
// JANGAN deploy ke publik sebelum dua langkah di atas selesai!
const CLIENT_ID      = "1030288606883-712ik0rkv9jkp0meivlv80jkkaksl09f.apps.googleusercontent.com";
const API_KEY        = "AIzaSyD5GK3ox9KGeyLBfed1P9ScqPA9aSNsW4Q";
const DISCOVERY_DOC  = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
const SCOPES         = "https://www.googleapis.com/auth/drive.file";
const DRIVE_FILENAME = "simery_backup.json";
const LS_FILE_ID     = "simery_drive_file_id";
const LS_HINT        = "simery_user_hint";
const LS_DISMISSED   = "simery_overlay_dismissed";
const LS_ACTIVE_USER = "simery_active_user"; // [GUARD] email user yang sedang aktif di IDB
const POLL_MS        = 30000;

let accessToken = null, tokenClient = null;
let driveFileId = localStorage.getItem(LS_FILE_ID) || null;
let driveStarted = false, isSyncing = false, syncPending = false, pollTimer = null;

// Inisialisasi Google Sign-In secara eksplisit (lebih aman dari deklarasi HTML-only)
// Dijalankan setelah GSI library siap
function initGoogleSignIn(){
  try {
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: false,
      // Matikan FedCM prompt otomatis ‚Äî penyebab COOP window.closed error di Edge
      use_fedcm_for_prompt: false,
      itp_support: true,
    });
  } catch(e) {
    console.warn('GSI initialize error (origin mungkin belum terdaftar di Google Console):', e.message);
  }
}

// Render tombol Sign-In dengan error handling (403 jika origin belum terdaftar)
function renderSignInButton(container, opts){
  if(!container) return;
  try {
    google.accounts.id.renderButton(container, opts);
  } catch(e) {
    // Origin belum terdaftar ‚Äî tampilkan tombol fallback manual
    container.innerHTML = `
      <button onclick="manualGoogleSignIn()" style="
        display:flex;align-items:center;gap:8px;padding:10px 20px;
        border:1.5px solid #dadce0;border-radius:8px;background:#fff;
        font-family:inherit;font-size:14px;font-weight:500;cursor:pointer;
        color:#3c4043;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" alt="G">
        Masuk dengan Google
      </button>`;
    console.warn('GSI renderButton gagal (origin belum terdaftar):', e.message);
  }
}

function manualGoogleSignIn(){
  // Popup manual sebagai fallback jika renderButton gagal
  if(typeof google !== 'undefined' && google.accounts && google.accounts.id){
    google.accounts.id.prompt();
  }
}

function decodeJwt(t){
  try{return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')))}catch(e){return{}}
}

function setSyncStatus(s){
  const el=document.getElementById('syncStatus');
  if(!el)return;
  const m={syncing:'‚è≥ Menyinkron‚Ä¶',ok:'‚òÅÔ∏è Tersinkron',error:'‚ö†Ô∏è Gagal sinkron',offline:'üì¥ Tidak tersambung',connecting:'üîÑ Menghubungkan‚Ä¶'};
  el.textContent=m[s]||'';
}

// ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showOverlay(){
  const ov=document.getElementById('loginOverlay');
  if(!ov)return;
  ov.style.display='flex';
  document.body.style.overflow='hidden';
  const c=document.getElementById('overlaySigninBtn');
  if(c&&c.children.length===0){
    renderSignInButton(c,{type:'standard',size:'large',theme:'outline',text:'sign_in_with',shape:'rectangular',width:280});
  }
  const ob=document.getElementById('overlayOfflineBtn');
  if(ob) ob.style.display='block';
}
function hideOverlay(){
  const ov=document.getElementById('loginOverlay');
  if(ov)ov.style.display='none';
  document.body.style.overflow='';
}
function dismissOverlay(){localStorage.setItem(LS_DISMISSED,'1');hideOverlay();}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleCredentialResponse(response){
  const p = decodeJwt(response.credential);
  const newEmail = p.email || '';
  const newName  = p.name  || newEmail;

  const prevEmail  = localStorage.getItem(LS_HINT)        || '';
  const activeUser = localStorage.getItem(LS_ACTIVE_USER) || '';

  // [GUARD] Deteksi login user berbeda dari yang datanya ada di IDB
  const isDifferentUser = prevEmail && newEmail && prevEmail !== newEmail;
  const hasLocalData    = state.items.length > 0 || (state.history && state.history.length > 0);

  if(isDifferentUser && hasLocalData){
    // Ada data milik user lain di lokal ‚Äî tanya dulu sebelum lanjut
    await handleUserSwitch({ prevEmail, newEmail, newName });
    return; // handleUserSwitch yang akan melanjutkan login setelah user konfirmasi
  }

  // Tidak ada konflik ‚Äî lanjut login normal
  await _finalizeLogin(newEmail);
}

// [GUARD] Tampilkan modal konfirmasi pergantian user, dengan opsi backup
async function handleUserSwitch({ prevEmail, newEmail, newName }){
  // [GUARD] Backup otomatis dulu sebelum tampilkan modal
  const backupKey = `simery_offline_backup_${prevEmail}_${Date.now()}`;
  try {
    localStorage.setItem(backupKey, JSON.stringify({
      savedAt   : new Date().toISOString(),
      savedBy   : prevEmail,
      items     : state.items,
      history   : state.history,
      lastModified: state.lastModified || 0
    }));
    // Bug fix: bersihkan backup lama, pertahankan hanya 3 terbaru per user
    const backupPrefix = `simery_offline_backup_${prevEmail}_`;
    const allKeys = Object.keys(localStorage).filter(k => k.startsWith(backupPrefix));
    if (allKeys.length > 3) {
      allKeys.sort().slice(0, allKeys.length - 3).forEach(k => localStorage.removeItem(k));
    }
  } catch(e) {
    console.warn('[GUARD] Backup offline gagal (storage penuh?):', e);
  }

  // Tampilkan modal peringatan
  showUserSwitchWarning({
    prevEmail,
    newEmail,
    newName,
    backupKey,
    onContinue: async () => {
      // User pilih lanjut ‚Üí hapus data lama, login sebagai user baru
      await idbPutState({ items: [], history: [] });
      localStorage.removeItem(LS_FILE_ID);
      driveFileId = null;
      state = { items: [], history: [] };
      buildItemMap();
      renderAll();
      await _finalizeLogin(newEmail, true);
      showNotification('info', `Login sebagai ${newName}`, 'Data akun sebelumnya telah diamankan sebagai backup lokal.');
    },
    onCancel: () => {
      // User batal ‚Üí hapus backup yang baru dibuat, tetap di sesi saat ini
      try { localStorage.removeItem(backupKey); } catch(e){}
      showNotification('info', 'Login dibatalkan', 'Anda tetap menggunakan data sesi sebelumnya.');
    },
    onDownload: () => {
      // Unduh data user lama sebagai file JSON sebelum lanjut
      try {
        const blob = new Blob([JSON.stringify({
          items  : state.items,
          history: state.history,
          exportedAt: new Date().toISOString(),
          exportedBy: prevEmail
        }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a   = document.createElement('a');
        a.href     = url;
        a.download = `simery_backup_${prevEmail.split('@')[0]}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        showNotification('success', 'Backup diunduh', 'File backup berhasil diunduh.');
      } catch(e) {
        showNotification('error', 'Gagal mengunduh backup');
      }
    }
  });
}

// [GUARD] Modal peringatan pergantian user
function showUserSwitchWarning({ prevEmail, newEmail, newName, onContinue, onCancel, onDownload }){
  // Buat overlay modal
  const overlay = document.createElement('div');
  overlay.id = 'userSwitchModal';
  overlay.style.cssText = `
    position:fixed;inset:0;z-index:9999;
    display:flex;align-items:center;justify-content:center;
    background:rgba(2,32,58,0.72);backdrop-filter:blur(8px);
    padding:20px;
  `;

  overlay.innerHTML = `
    <div style="
      background:#fff;border-radius:20px;padding:24px;width:100%;max-width:360px;
      box-shadow:0 24px 60px rgba(0,0,0,0.25);
      animation:slideUp 0.3s cubic-bezier(0.34,1.2,0.64,1) both;
    ">
      <!-- Icon -->
      <div style="text-align:center;margin-bottom:16px;">
        <div style="
          width:60px;height:60px;border-radius:16px;margin:0 auto 12px;
          background:linear-gradient(135deg,#fff7ed,#ffedd5);
          border:1.5px solid #fed7aa;
          display:flex;align-items:center;justify-content:center;font-size:28px;
        ">‚ö†Ô∏è</div>
        <div style="font-weight:800;font-size:16px;color:var(--text);letter-spacing:-0.02em;">Pergantian Akun Terdeteksi</div>
      </div>

      <!-- Info -->
      <div style="
        background:#fff7ed;border:1.5px solid #fed7aa;border-radius:12px;
        padding:12px 14px;margin-bottom:16px;font-size:12.5px;line-height:1.6;color:#92400e;
      ">
        <div style="font-weight:700;margin-bottom:6px;">‚ö† Data belum tersinkronisasi!</div>
        Ada perubahan data dari <strong>${prevEmail}</strong> yang dibuat secara offline dan belum ter-upload ke Drive.
        Jika kamu lanjut login sebagai <strong>${newName}</strong>, data ini <strong>akan digantikan</strong> oleh data akun baru.
      </div>

      <!-- Akun info -->
      <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;margin-bottom:20px;">
        <div style="background:#f1f5f9;border-radius:10px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:700;margin-bottom:2px;">SAAT INI</div>
          <div style="font-size:12px;font-weight:600;color:var(--text);word-break:break-all;">${prevEmail.split('@')[0]}</div>
        </div>
        <div style="font-size:16px;color:var(--muted);">‚Üí</div>
        <div style="background:linear-gradient(135deg,var(--blue-light),#e0f2fe);border:1.5px solid var(--blue-mid);border-radius:10px;padding:10px;text-align:center;">
          <div style="font-size:10px;color:var(--blue-dark);font-weight:700;margin-bottom:2px;">LOGIN BARU</div>
          <div style="font-size:12px;font-weight:600;color:var(--blue-dark);word-break:break-all;">${newEmail.split('@')[0]}</div>
        </div>
      </div>

      <!-- Actions -->
      <div style="display:grid;gap:8px;">
        <button id="uswDownload" style="
          width:100%;padding:11px;border-radius:10px;border:1.5px solid rgba(14,165,233,0.2);
          background:#f0f9ff;font-family:inherit;font-size:13px;font-weight:700;
          color:var(--blue-dark);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;
          transition:all 0.15s;
        ">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/></svg>
          Unduh Backup Data Dulu
        </button>
        <button id="uswContinue" style="
          width:100%;padding:11px;border-radius:10px;border:none;
          background:linear-gradient(135deg,#f97316,#fb923c);
          font-family:inherit;font-size:13px;font-weight:700;color:#fff;cursor:pointer;
          box-shadow:0 2px 8px rgba(249,115,22,0.3);transition:all 0.15s;
        ">Lanjut Login, Ganti Data</button>
        <button id="uswCancel" style="
          width:100%;padding:10px;border-radius:10px;border:1.5px solid rgba(14,165,233,0.15);
          background:#fff;font-family:inherit;font-size:13px;font-weight:600;
          color:var(--muted);cursor:pointer;transition:all 0.15s;
        ">Batal, Tetap di Sesi Ini</button>
      </div>
      <div style="text-align:center;margin-top:12px;font-size:11px;color:var(--text-3);">
        üîí Backup otomatis telah disimpan di perangkat ini
      </div>
    </div>
  `;

  document.body.appendChild(overlay);

  overlay.querySelector('#uswDownload').addEventListener('click', () => { onDownload(); });
  overlay.querySelector('#uswContinue').addEventListener('click', () => {
    overlay.remove();
    onContinue();
  });
  overlay.querySelector('#uswCancel').addEventListener('click', () => {
    overlay.remove();
    onCancel();
  });
}

async function _finalizeLogin(email, suppressSyncNotif = false){
  _suppressSyncNotif = suppressSyncNotif;
  localStorage.setItem("google_logged_in","true");
  localStorage.removeItem(LS_DISMISSED);
  localStorage.setItem(LS_HINT, email);
  localStorage.setItem(LS_ACTIVE_USER, email);

  document.querySelectorAll(".g_id_signin").forEach(d=>d.style.display="none");
  document.getElementById("logoutBtn").style.display="inline-flex";
  hideOverlay();
  startDrive();
  // Reset flag setelah Drive selesai init (estimasi 5 detik)
  setTimeout(() => { _suppressSyncNotif = false; }, 5000);
}

function startDrive(){
  if(driveStarted)return;
  driveStarted=true;
  setSyncStatus('connecting');
  gapi.load("client",async()=>{
    await gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]});
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID,scope:SCOPES,
      callback:onTokenReceived,
      error_callback:onTokenError,
    });
    // Coba silent refresh dulu (prompt:'none') ‚Äî tidak buka popup/tab
    requestTokenSilent();
  });
}

// Silent: tidak buka popup sama sekali, berhasil jika user sudah pernah grant
function requestTokenSilent(){
  const hint=localStorage.getItem(LS_HINT)||'';
  try{
    tokenClient.requestAccessToken({prompt:'none',login_hint:hint});
  }catch(e){
    // Fallback jika browser tidak support prompt:none
    requestTokenWithConsent();
  }
}

// Consent popup (hanya dipanggil saat tombol "Hubungkan Drive" diklik user)
function requestTokenWithConsent(){
  const hint=localStorage.getItem(LS_HINT)||'';
  tokenClient.requestAccessToken({prompt:'',login_hint:hint});
}

async function onTokenReceived(resp){
  if(resp.error){onTokenError({type:resp.error});return;}
  accessToken=resp.access_token;
  gapi.client.setToken({access_token:accessToken});
  const cb=document.getElementById('connectDriveBtn');
  if(cb)cb.style.display='none';
  await pullFromDrive();
  if(syncPending){syncPending=false;await pushToDrive(state);}
  startPolling();
  window.addEventListener("focus",onFocus);
  // Jadwalkan silent refresh sebelum token kedaluwarsa (¬±55 menit)
  scheduleTokenRefresh(resp.expires_in||3600);
}

let _refreshTimer=null;
function scheduleTokenRefresh(expiresInSec){
  if(_refreshTimer)clearTimeout(_refreshTimer);
  const refreshAt=Math.max((expiresInSec-300),60)*1000; // 5 menit sebelum expire
  _refreshTimer=setTimeout(()=>{if(accessToken)requestTokenSilent();},refreshAt);
}

function onTokenError(err){
  console.warn("Drive token error:",err.type);
  if(err.type==='interaction_required'||err.type==='consent_required'||err.type==='login_required'){
    // Butuh interaksi user ‚Äî tampilkan tombol Hubungkan Drive, jangan buka popup otomatis
    const cb=document.getElementById('connectDriveBtn');
    if(cb)cb.style.display='inline-flex';
    setSyncStatus('offline');
    showNotification('info','Hubungkan Google Drive','Klik tombol "Hubungkan Drive" di header untuk sinkronisasi');
  } else if(err.type==='popup_blocked_by_browser'||err.type==='popup_failed_to_open'){
    // Popup diblokir ‚Äî coba silent, lalu tampilkan tombol
    const cb=document.getElementById('connectDriveBtn');
    if(cb)cb.style.display='inline-flex';
    setSyncStatus('offline');
    showNotification('warning','Pop-up diblokir browser','Klik tombol "Hubungkan Drive" untuk mencoba ulang');
  } else if(err.type==='access_denied'){
    const cb=document.getElementById('connectDriveBtn');
    if(cb)cb.style.display='inline-flex';
    setSyncStatus('offline');
  } else {
    setSyncStatus('offline');
    // Coba silent refresh setelah beberapa detik
    setTimeout(()=>{if(!accessToken)requestTokenSilent();},5000);
  }
}

document.getElementById('connectDriveBtn').addEventListener('click',()=>{
  setSyncStatus('connecting');
  if(tokenClient) requestTokenWithConsent();
  else{driveStarted=false;startDrive();}
});

async function onFocus(){if(accessToken&&!isSyncing)await pullFromDrive();}

function startPolling(){
  if(pollTimer)clearInterval(pollTimer);
  pollTimer=setInterval(()=>{if(accessToken&&!isSyncing)pullFromDrive();},POLL_MS);
}

// ‚îÄ‚îÄ Pull ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pullFromDrive(){
  if(isSyncing)return;
  isSyncing=true;setSyncStatus('syncing');
  try{
    if(!driveFileId){
      const res=await gapi.client.drive.files.list({q:`name='${DRIVE_FILENAME}' and trashed=false`,spaces:"drive",fields:"files(id)",pageSize:1});
      if(res.result.files.length>0){driveFileId=res.result.files[0].id;localStorage.setItem(LS_FILE_ID,driveFileId);}
    }
    if(!driveFileId){isSyncing=false;await pushToDrive(state);return;}
    const resp=await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`,{headers:{Authorization:"Bearer "+accessToken}});
    if(resp.status===401){accessToken=null;isSyncing=false;setSyncStatus('connecting');requestTokenSilent();return;}
    if(resp.status===404){driveFileId=null;localStorage.removeItem(LS_FILE_ID);isSyncing=false;await pushToDrive(state);return;}
    if(!resp.ok){setSyncStatus('error');isSyncing=false;return;}
    const driveData=await resp.json();
    if((driveData.lastModified||0)>(state.lastModified||0)){
      // [GUARD] Cek apakah ada data lokal yang belum pernah ke-sync ke Drive
      // Jika state.lastModified ada tapi Drive lebih baru DAN ada item lokal ‚Üí potensi konflik
      const hasLocalUnsync = (state.lastModified||0) > 0 && state.items.length > 0 && !syncPending;
      if(hasLocalUnsync){
        // Backup otomatis data lokal sebelum ditimpa
        const activeUser = localStorage.getItem(LS_ACTIVE_USER) || 'unknown';
        try {
          localStorage.setItem(
            `simery_auto_backup_${activeUser}_${Date.now()}`,
            JSON.stringify({ savedAt: new Date().toISOString(), items: state.items, history: state.history, lastModified: state.lastModified })
          );
        } catch(e){ console.warn('[GUARD] Auto-backup gagal:', e); }
      }
      state=driveData;
      buildItemMap();
      await idbPutState(state);
      if(typeof renderAll==='function')renderAll();
      if(!_suppressSyncNotif) showNotification("info","Data diperbarui dari perangkat lain");
    }
    setSyncStatus('ok');
  }catch(err){console.error("pullFromDrive:",err);setSyncStatus('error');}
  finally{isSyncing=false;}
}

// ‚îÄ‚îÄ Push ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pushToDrive(data){
  if(!accessToken)return;
  setSyncStatus('syncing');
  const body=JSON.stringify(data);
  const meta=JSON.stringify({name:DRIVE_FILENAME,mimeType:"application/json"});
  const makeForm=()=>{const f=new FormData();f.append("metadata",new Blob([meta],{type:"application/json"}));f.append("file",new Blob([body],{type:"application/json"}));return f;};
  try{
    let res;
    if(driveFileId){
      res=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`,{method:"PATCH",headers:{Authorization:"Bearer "+accessToken},body:makeForm()});
      if(res.status===401){accessToken=null;setSyncStatus('connecting');requestTokenSilent();return;}
      if(res.status===404){driveFileId=null;localStorage.removeItem(LS_FILE_ID);await pushToDrive(data);return;}
    } else {
      res=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",{method:"POST",headers:{Authorization:"Bearer "+accessToken},body:makeForm()});
      if(res.ok){const j=await res.json();driveFileId=j.id;localStorage.setItem(LS_FILE_ID,driveFileId);}
    }
    setSyncStatus(res&&res.ok?'ok':'error');
  }catch(err){console.error("pushToDrive:",err);setSyncStatus('error');}
}

function syncToDrive(data){if(!accessToken){syncPending=true;return;}pushToDrive(data);}

// [FIX #6] Debounced sync ‚Äî tunggu 3 detik setelah operasi terakhir sebelum kirim ke Drive
// Ini mencegah 10x API call saat user melakukan banyak operasi berturut-turut
let _driveSyncTimer = null;
function debouncedSyncToDrive(data) {
  if (!accessToken) { syncPending = true; return; }
  clearTimeout(_driveSyncTimer);
  _driveSyncTimer = setTimeout(() => {
    pushToDrive(data);
  }, 3000);
}

// ‚îÄ‚îÄ Logout: show overlay, keep data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("logoutBtn").addEventListener("click",()=>{
  // [FIX #7] Konfirmasi sebelum logout agar tidak terjadi tidak sengaja
  showConfirmModal({
    icon: 'üö™',
    iconBg: 'linear-gradient(135deg,#fff1f3,#fff5f7)',
    iconBorder: '#fecdd3',
    title: 'Keluar dari Akun?',
    desc: 'Anda akan keluar dari akun Google. Data lokal tetap tersimpan dan bisa diakses kembali setelah login ulang.',
    okLabel: 'Ya, Keluar',
    okClass: 'danger',
    onConfirm: () => {
      google.accounts.id.disableAutoSelect();
      if(pollTimer)clearInterval(pollTimer);
      if(_driveSyncTimer)clearTimeout(_driveSyncTimer);
      window.removeEventListener("focus",onFocus);
      localStorage.removeItem("google_logged_in");
      localStorage.removeItem(LS_FILE_ID);
      localStorage.removeItem(LS_ACTIVE_USER);
      // Sengaja TIDAK hapus LS_HINT ‚Äî dipakai untuk deteksi ganti akun saat login berikutnya
      localStorage.removeItem(LS_DISMISSED);
      accessToken=null;driveFileId=null;driveStarted=false;
      document.getElementById("logoutBtn").style.display="none";
      const cb=document.getElementById('connectDriveBtn');if(cb)cb.style.display='none';
      document.querySelector(".g_id_signin").style.display="block";
      setSyncStatus('');
      showOverlay();
    }
  });
});

// ‚îÄ‚îÄ Page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener("load",()=>{
  // Inisialisasi GSI setelah library siap
  if(typeof google !== 'undefined' && google.accounts){
    initGoogleSignIn();
  } else {
    // Library belum siap (async), tunggu sebentar
    setTimeout(()=>{
      if(typeof google !== 'undefined' && google.accounts) initGoogleSignIn();
    }, 500);
  }

  const loggedIn=localStorage.getItem("google_logged_in")==="true";
  const dismissed=localStorage.getItem(LS_DISMISSED)==="1";
  if(loggedIn){
    // Pastikan LS_ACTIVE_USER terisi jika user sudah login sebelumnya
    const hint = localStorage.getItem(LS_HINT)||'';
    if(hint && !localStorage.getItem(LS_ACTIVE_USER)) localStorage.setItem(LS_ACTIVE_USER, hint);
    document.querySelector(".g_id_signin").style.display="none";
    document.getElementById("logoutBtn").style.display="inline-flex";
    startDrive();
  } else if(!dismissed){
    setTimeout(showOverlay,300);
  }
});
</script>

</body>
</html>
